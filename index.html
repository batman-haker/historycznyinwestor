<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historyczny Inwestor â€” Wersja Edukacyjna</title>
  <style>
    :root {
      --bg: #0f1222; --panel:#15182a; --text:#eef3ff; --muted:#cbd5e1;
      --accent:#8b5cf6; --accent-2:#22d3ee; --border:#2a2e44;
      --win:#22c55e; --loss:#ef4444; --neutral:#f59e0b; --shadow:rgba(0,0,0,.4);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0; color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(139,92,246,.15), rgba(0,0,0,0) 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(34,211,238,.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #0b0e1a, #0f1222 45%, #0a0c18 100%);
    }
    .container { max-width:1200px; margin:0 auto; padding:24px; }
    .main-menu { text-align:center; padding:48px 16px; }
    .main-title { font-size: clamp(1.8rem,3.8vw,3rem); margin:0 0 8px; font-weight:800; letter-spacing:-.02em; }
    .main-title span { background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .main-subtitle { color:var(--muted); margin:0 0 24px; }
    .chapter-selection { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
    .chapter-card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; padding:20px; text-align:left; cursor:pointer; transition: transform .25s, box-shadow .25s, border-color .25s; box-shadow:0 10px 30px var(--shadow); }
    .chapter-card:hover { transform: translateY(-4px); border-color: rgba(139,92,246,.6); box-shadow:0 16px 40px rgba(34,211,238,.16); }
    .chapter-era { font-weight:800; letter-spacing:.02em; color:var(--accent-2); }
    .chapter-name { font-size:1.25rem; margin:8px 0; font-weight:700; }
    .chapter-description { color:var(--muted); font-size:.95rem; line-height:1.45; }
    .hidden { display:none; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    .back-btn { background: linear-gradient(90deg, rgba(139,92,246,.3), rgba(34,211,238,.3)); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .back-btn:hover { filter:brightness(1.1); transform: translateY(-1px); }
    .progress-outer { width:100%; height:10px; background:#0d1122; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .progress-inner { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .4s ease; }
    .header { display:grid; gap:8px; margin-bottom:16px; }
    .title { font-size: clamp(1.5rem,2.5vw,2.2rem); margin:0; }
    .subtitle { color:var(--muted); margin:0; }
    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px; }
    .stat-card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px 14px; }
    .stat-label { color:var(--muted); font-size:.8rem; }
    .stat-value { font-size:1.25rem; font-weight:800; }
    .layout { display:grid; grid-template-columns:1.08fr .92fr; gap:16px; margin-top:16px; }
    @media (max-width:900px){ .layout{ grid-template-columns:1fr; } }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 30px var(--shadow); }
    .panel-title { margin:0 0 10px; font-size:1.1rem; letter-spacing:.01em; }
    .scenario-text { color:#e6ebff; opacity:.95; line-height:1.6; margin-bottom:14px; }
    .choices { display:grid; gap:10px; }
    .choice-btn { border:1px solid var(--border); background:#1a1d32; color:var(--text); padding:12px 14px; border-radius:12px; text-align:left; cursor:pointer; font-weight:600; transition: transform .18s, border-color .18s, background .18s; }
    .choice-btn:hover { transform: translateY(-1px); border-color: rgba(34,211,238,.6); background:#1e2140; }
    .stock-list { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .stock-item { display:flex; align-items:center; justify-content:space-between; background:#151935; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .stock-name { font-weight:700; }
    .stock-price { color:var(--accent-2); font-variant-numeric: tabular-nums; }
    .result-panel { grid-column:1/-1; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; padding:18px; text-align:center; box-shadow:0 10px 30px var(--shadow); }
    .profit { color:var(--win); font-weight:800; }
    .loss { color:var(--loss); font-weight:800; }
    .neutral { color:var(--neutral); font-weight:800; }
    .restart { display:inline-flex; gap:8px; align-items:center; margin-top:10px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0a0c18; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; }
    .restart:hover { filter:brightness(1.05); }
    .hint-btn { background:transparent; color:var(--accent-2); border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .hint-btn:hover { background: rgba(34,211,238,.08); border-color: rgba(34,211,238,.5); transform: translateY(-1px); }
    .hint-box { display:none; margin-top:12px; border-left:3px solid var(--accent-2); padding:12px 14px; color:var(--muted); background: rgba(34,211,238,.08); border-radius:0 10px 10px 0; }
    .hint-box[aria-hidden="false"] { display:block; }
    .scenario-graphic { margin:8px 0 12px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .photo { margin-top:8px; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .photo img { display:block; width:100%; height:auto; }
    .error { margin:16px 0; color:#fecaca; background:#7f1d1d; border:1px solid #991b1b; padding:10px 12px; border-radius:10px; display:none; }
    .hidden { display:none !important; }

    /* NOWE STYLE DLA MENU */
    .game-cover-logo { width:100%; max-width:400px; margin:0 auto 30px; }
    .game-cover-logo img { width:100%; height:auto; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.6); border:3px solid var(--accent-2); transition: transform .3s ease; }
    .game-cover-logo img:hover { transform: scale(1.02); box-shadow:0 25px 70px rgba(139,92,246,0.4); }
    .menu-buttons-container { display:flex; flex-direction:column; gap:16px; max-width:500px; margin:24px auto 0; }
    .menu-main-btn { padding:18px 32px; font-size:1.2rem; font-weight:700; border:none; border-radius:12px; cursor:pointer; transition: all .3s ease; text-align:center; }
    .menu-main-btn:hover { transform: translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,.3); }
    .primary-btn { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0a0c18; }
    .primary-btn:hover { filter:brightness(1.1); }
    .secondary-btn { background: linear-gradient(135deg, rgba(139,92,246,.3), rgba(34,211,238,.3)); border:1px solid var(--border); color:var(--text); }
    .secondary-btn:hover { background: linear-gradient(135deg, rgba(139,92,246,.4), rgba(34,211,238,.4)); border-color: var(--accent-2); }
    .tertiary-btn { background:transparent; border:1px solid var(--border); color:var(--text); }
    .tertiary-btn:hover { background: rgba(255,255,255,.05); border-color: var(--accent); }

    /* MODAL */
    .epoch-modal { position:fixed; top:0; left:0; width:100%; height:100vh; z-index:9999; display:flex; align-items:center; justify-content:center; }
    .modal-backdrop { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.85); backdrop-filter:blur(8px); }
    .modal-box { position:relative; z-index:10000; background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:32px; max-width:1100px; max-height:85vh; overflow-y:auto; box-shadow:0 25px 80px rgba(0,0,0,.8); }
    .modal-title { font-size:2.2rem; margin:0 0 8px; text-align:center; background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .modal-subtitle { text-align:center; color:var(--muted); margin:0 0 24px; font-size:1.05rem; }
    .modal-close { display:block; margin:24px auto 0; padding:12px 32px; background: linear-gradient(135deg, #e74c3c, #c0392b); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:1.1rem; transition: all .3s ease; }
    .modal-close:hover { transform: translateY(-2px); box-shadow:0 8px 20px rgba(231,76,60,.5); }
    .modal-box::-webkit-scrollbar { width:10px; }
    .modal-box::-webkit-scrollbar-track { background:rgba(255,255,255,.05); border-radius:10px; }
    .modal-box::-webkit-scrollbar-thumb { background:var(--accent-2); border-radius:10px; }
    .modal-box::-webkit-scrollbar-thumb:hover { background:var(--accent); }

    /* ACHIEVEMENT NOTIFICATIONS */
    .achievement-notification { position:fixed; top:20px; right:-400px; background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.95)); backdrop-filter:blur(10px); padding:16px 20px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.5); z-index:10001; transition: right .5s ease; min-width:300px; border:2px solid var(--gold); }
    .achievement-notification.show { right:20px; }
    .achievement-content { display:flex; align-items:center; gap:12px; }
    .achievement-icon { font-size:2.5rem; }
    .achievement-name { font-weight:800; font-size:1.1rem; color:#fff; }
    .achievement-desc { font-size:0.9rem; color:#eef; opacity:0.9; }

    /* CAPITAL CHART */
    .capital-chart { width:100%; height:200px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; margin:20px 0; }
    .chart-line { stroke:var(--accent-2); stroke-width:3; fill:none; }
    .chart-area { fill:url(#chartGradient); opacity:0.3; }
    .chart-grid { stroke:rgba(255,255,255,0.1); stroke-width:1; }
    .chart-label { fill:var(--muted); font-size:12px; }

    /* ACHIEVEMENTS DISPLAY */
    .achievements-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin:16px 0; }
    .achievement-badge { background:rgba(139,92,246,0.2); border:1px solid var(--border); border-radius:10px; padding:12px; text-align:center; }
    .achievement-badge-icon { font-size:2rem; display:block; margin-bottom:6px; }
    .achievement-badge-name { font-size:0.85rem; font-weight:700; color:var(--text); }
  </style>
<script type="text/javascript" nonce="fbaf3247a48d4e4a8f9106ab1e1" src="//local.adguard.org?ts=1754656650365&amp;type=content-script&amp;dmn=mail-attachment.googleusercontent.com&amp;url=https%3A%2F%2Fmail-attachment.googleusercontent.com%2Fattachment%2Fu%2F0%2F%3Fui%3D2%26ik%3Df2ae618626%26attid%3D0.1%26permmsgid%3Dmsg-a%3Ar1370544206735525610%26th%3D19889e3900ffb5b5%26view%3Datt%26disp%3Dsafe%26realattid%3Df_me2v9lx50%26zw%26saddbat%3DANGjdJ9tnBx_fnmLD0gV18C3e8AnDwqW-CBoSG5TniDTP7IlJxdF3c7fYm1JqWHOp1e2U9TvLYbN-S64edVSp36JLaz7lgEc4vSYRpervdKBj2MWW2Ntn3HBxZVgr9bHNRnIC2GH-o-aTVqiITTbwjK6m35XDD3sTWXR9z6IIFLWdTv9OMC80sMRwu7aSEIuiCvfHTPm_eiGFWgoLnWc-VZkHCw4JXkL0q5t3iNEwoJVjtwnwRhPB3zRA51A6WN91SU_ZnAsTCRiPXd0Msyv2fRmUcHn2k_sopUnWRhtgY5u_VoQoIX030s-Zcuh0zJo6TKagK77NwE-bfelFjigt7DCc31dXx7WGPV7smw7gaUr9YHpDXAueoQIoLQWRedXTPQRiufiugXAnck0-1NRrGAAqW6p5j4FObQXhuFeE9Mh2j8tSo-HV-wluEhwmBT87d7Xy1OOu_-rSgkdbiOk-yHROdxp3tVK8Iyge5fA6Zc88exedhQbCKYDWlU7j8wGlblf5BWObkyVKv0kUmKz7iLM1nYMdzMFFHjkEQiVWG7tT6XqnDDI-vpY4je5GRtV0qwUPxb2C9NoXTzqoNVbua0ZXTQgzJHq9W6Y6N7dgMxIJE2DuZzrreT27qAi495WlA2N0h2A_zI4Fy1Hv5PPyJ96DmfPAk4j2i1q0CCSybCT3BbeKkMOI0rgyyxRbq8UzouKTlOtpAgzrrhBDUAn-wn82BdpK5DrhOnMFii0TuNUuTPPAsjJSS5klGGZDS3O-pSyP0ag3oJg4nEAnIC52JuNpOYISp4vEefezHjrMPn74LnIR9D5SsIlpkm1ZCf-Tk2YtKz8kaMOlL-1MatxeXXR0wxxXNrKVCbffgEDVQ4xWilbjmLE_MvNdd0WafGDjkvVXEf_pWTOZJhp6HV0N5B7ViNarFcExpGJdq2Ebas0Hp1jI-es8lrVhvlv1eFF5SDbsXbsVf8Vb8fKZ5QKHMtA0fjL7-mrWSHXlr0V0Rt9uNKCqAIJ_4EF3mEEVWs0pHlUZyEG237H9Y-IHB1zAGy1gACIP5KpIx2yqPXf643aBfFM_Teq1mO7VZXxz3L4wYcnniaZ13f-PqnnMixv&amp;app=chrome.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="fbaf3247a48d4e4a8f9106ab1e1" src="//local.adguard.org?ts=1754656650365&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script></head>
<body>
  <div class="container">
    <!-- EKRAN POWITALNY Z GUZIKAMI -->
    <section id="welcomeScreen" class="main-menu" aria-labelledby="welcomeHeading">
      <div class="game-cover-logo">
        <img src="kochampatronow_okadka_gry_dla_inwestora_giedowego_z_elementam_1f221263-b989-4da4-8eb4-42536d07774d.png" alt="Historyczny Inwestor - OkÅ‚adka">
      </div>
      <h1 id="welcomeHeading" class="main-title">Historyczny <span>Inwestor</span></h1>
      <p class="main-subtitle">Przetrwaj najwiÄ™ksze wstrzÄ…sy rynkowe i zrozum, co siÄ™ wtedy dziaÅ‚o â€” krok po kroku.</p>
      <div class="menu-buttons-container">
        <button class="menu-main-btn primary-btn" id="quickStartBtn">ğŸ® Szybki Start</button>
        <button class="menu-main-btn secondary-btn" id="chooseEpochBtn">ğŸ•°ï¸ Wybierz EpokÄ™</button>
        <button class="menu-main-btn tertiary-btn" id="aboutBtn">â„¹ï¸ O Grze</button>
      </div>
    </section>

    <!-- MODAL WYBORU EPOKI -->
    <div id="epochModal" class="epoch-modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-backdrop" id="modalBackdrop"></div>
      <div class="modal-box">
        <h2 id="modalTitle" class="modal-title">ğŸ•°ï¸ Wybierz EpokÄ™ HistorycznÄ…</h2>
        <p class="modal-subtitle">Zacznij swojÄ… przygodÄ™ od wybranego kryzysu finansowego</p>
        <div id="errorBox" class="error"></div>
        <div class="chapter-selection" id="chapterSelection"></div>
        <button class="modal-close" id="closeModalBtn" aria-label="Zamknij">âŒ Zamknij</button>
      </div>
    </div>

    <!-- STARE MENU (teraz ukryte, uÅ¼ywane tylko przez modal) -->
    <section id="mainMenu" class="hidden" aria-labelledby="menuHeading">
      <h1 id="menuHeading" class="main-title">Historyczny <span>Inwestor</span></h1>
      <p class="main-subtitle">Przetrwaj najwiÄ™ksze wstrzÄ…sy rynkowe i zrozum, co siÄ™ wtedy dziaÅ‚o â€” krok po kroku.</p>
    </section>

    <section id="gameArea" class="hidden" aria-live="polite">
      <div class="topbar">
        <button class="back-btn" id="backBtn" aria-label="WrÃ³Ä‡ do menu">â† PowrÃ³t</button>
        <div class="progress-outer" aria-hidden="true"><div id="progressBar" class="progress-inner"></div></div>
      </div>

      <header class="header">
        <h2 id="chapterTitle" class="title">â€”</h2>
        <p id="chapterSubtitle" class="subtitle">â€”</p>
        <div class="stats" role="group" aria-label="Statystyki gry">
          <div class="stat-card"><div class="stat-label">KapitaÅ‚</div><div id="capital" class="stat-value">$1,000</div></div>
          <div class="stat-card"><div class="stat-label">Okres</div><div id="month" class="stat-value">â€”</div></div>
          <div class="stat-card"><div id="indexLabel" class="stat-label">Indeks</div><div id="indexValue" class="stat-value">â€”</div></div>
          <div class="stat-card"><div class="stat-label">Decyzje</div><div id="decisions" class="stat-value">0</div></div>
        </div>
      </header>

      <div class="layout" id="gameContent"></div>
    </section>
  </div>

  <script>
  (function(){
    const errorBox = document.getElementById('errorBox');
    function showError(msg){
      errorBox.textContent = 'BÅ‚Ä…d skryptu: ' + msg;
      errorBox.style.display = 'block';
    }

    try {
      // --------- STATE ---------
      let currentChapterKey = null;
      let capital = 1000;
      let currentScenario = 0;
      let decisions = 0;
      let capitalHistory = []; // Track capital over time
      let achievements = []; // Track unlocked achievements

      const dom = {
        mainMenu: document.getElementById('mainMenu'),
        gameArea: document.getElementById('gameArea'),
        chapterTitle: document.getElementById('chapterTitle'),
        chapterSubtitle: document.getElementById('chapterSubtitle'),
        indexLabel: document.getElementById('indexLabel'),
        capital: document.getElementById('capital'),
        month: document.getElementById('month'),
        indexValue: document.getElementById('indexValue'),
        decisions: document.getElementById('decisions'),
        gameContent: document.getElementById('gameContent'),
        chapterSelection: document.getElementById('chapterSelection'),
        backBtn: document.getElementById('backBtn'),
        progressBar: document.getElementById('progressBar')
      };

      // --------- MENU SYSTEM ---------
      const welcomeScreen = document.getElementById('welcomeScreen');
      const epochModal = document.getElementById('epochModal');
      const quickStartBtn = document.getElementById('quickStartBtn');
      const chooseEpochBtn = document.getElementById('chooseEpochBtn');
      const aboutBtn = document.getElementById('aboutBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const modalBackdrop = document.getElementById('modalBackdrop');

      function showWelcomeScreen(){
        welcomeScreen.classList.remove('hidden');
        dom.gameArea.classList.add('hidden');
        epochModal.classList.add('hidden');
      }

      function hideWelcomeScreen(){
        welcomeScreen.classList.add('hidden');
      }

      function showModal(){
        console.log('ğŸ­ Opening modal...');
        epochModal.classList.remove('hidden');
        console.log('ğŸ“¦ chapterSelection element:', dom.chapterSelection);
        buildMenu(); // Populate modal with chapters
        console.log('âœ… Modal opened');
      }

      function hideModal(){
        epochModal.classList.add('hidden');
      }

      // Initialize menu system AFTER DOM loads
      function initMenuSystem(){
        console.log('ğŸ® Initializing menu system...');

        dom.backBtn.addEventListener('click', () => {
          console.log('Back button clicked');
          showWelcomeScreen();
        });

        quickStartBtn.addEventListener('click', () => {
          console.log('Quick start clicked');
          hideWelcomeScreen();
          startChapter('1930s');
        });

        chooseEpochBtn.addEventListener('click', () => {
          console.log('Choose epoch clicked');
          showModal();
        });

        aboutBtn.addEventListener('click', () => {
          console.log('About clicked');
          alert('ğŸ“ˆ HISTORYCZNY INWESTOR - Wersja Edukacyjna\n\nWciel siÄ™ w rolÄ™ inwestora przeÅ¼ywajÄ…cego najwiÄ™ksze kryzysy finansowe ostatnich 100 lat.\n\nğŸ¯ Cel: Zrozum mechanizmy rynkowe i naucz siÄ™ podejmowaÄ‡ mÄ…dre decyzje\nğŸ“š 5 Epok: Od Wielkiego Kryzysu 1929 do Kryzysu Finansowego 2008\nğŸ’¡ Ucz siÄ™ na bÅ‚Ä™dach historii!\n\nWersja: 3.0-complete');
        });

        closeModalBtn.addEventListener('click', () => {
          console.log('Close modal clicked');
          hideModal();
        });

        modalBackdrop.addEventListener('click', () => {
          console.log('Backdrop clicked');
          hideModal();
        });

        console.log('âœ… Menu system initialized');
      }

      // --------- HINTS (obszerne tÅ‚a historyczne â€” ukryte do klikniÄ™cia) ---------
      const hints = {
        '1930s': [
          'Czarny Czwartek/Wtorek (1929) uruchamia lawinÄ™ margin-calli. Standard zÅ‚ota ogranicza elastycznoÅ›Ä‡ banku centralnego. Brak ubezpieczenia depozytÃ³w pogÅ‚Ä™bia panikÄ™.',
          'Smootâ€“Hawley ogranicza handel; popyt sÅ‚abnie, deflacja zwiÄ™ksza realny ciÄ™Å¼ar dÅ‚ugÃ³w.',
          'â€Odbicia niedÅºwiedzieâ€ kuszÄ…, ale fundamenty sÅ‚abnÄ….',
          'Fale bankructw i bezrobocie. PrzewagÄ™ majÄ… defensywy i gotÃ³wka.',
          'Lato 1932 â€“ historyczne dno; kupowanie jakoÅ›ci nagradzane, ale ryzyko nadal wysokie.',
          '1933: Bank holiday, FDIC, programy publiczne i dewaluacja dolara stabilizujÄ… system.'
        ],
        '1970s': [
          'Embargo OPEC (1973) winduje ceny ropy; szok podaÅ¼owy i poczÄ…tek stagflacji.',
          'Limity cen â†’ niedobory; gotÃ³wka i zwykÅ‚e obligacje przegrywajÄ… z inflacjÄ….',
          'Watergate i wysokie stopy: przewagÄ™ majÄ… dywidendy i metale szlachetne.',
          'Recesja 1974â€“75; â€jakoÅ›Ä‡ po przecenieâ€ bywa nagradzana.',
          'WydajnoÅ›Ä‡ roÅ›nie dziÄ™ki oszczÄ™dzaniu energii i automatyzacji.',
          '1979: drugi szok naftowy i wyÅ¼sza inflacja.'
        ],
        '1990s': [
          'Recesja na starcie dekady, problemy S&L, Gulf War â€“ defensywy w cenie.',
          '1994â€“96: â€soft landingâ€; produktywnoÅ›Ä‡ roÅ›nie dziÄ™ki IT i globalizacji.',
          '1997: kryzys azjatycki â€“ â€flight to qualityâ€.',
          '1998: LTCM, dÅºwignia i korelacje; â€donâ€™t fight the Fedâ€.',
          '1999: euforia internetowa â€“ uwaga na rozjazd wycen i zyskÃ³w.'
        ],
        'DotCom': [
          '2000: kulminacja bÄ…bla; wiele spÃ³Å‚ek bez zyskÃ³w, szybkie IPO.',
          'PÅ‚ynnoÅ›Ä‡ wysycha; quality-tech trzyma siÄ™ lepiej.',
          '9/11: szok popytowy; polityka pieniÄ™Å¼na Å‚agodzi skutki.',
          '2002: pÃ³Åºne dno; zostajÄ… liderzy z gotÃ³wkÄ… i moatami.'
        ],
        'BlackMonday': [
          'Portfolio insurance to automatyczne systemy sprzedaÅ¼y â€“ gdy rynek spada, automatycznie dosprzedajÄ….',
          'Fed szybko reaguje â€“ obniÅ¼a stopy i zapewnia pÅ‚ynnoÅ›Ä‡. To zapobiega recesji.',
          'Krach byÅ‚ bardziej techniczny niÅ¼ fundamentalny â€“ gospodarka USA mocna.',
          'Opcje put to zabezpieczenie â€“ gdy rynek spada, rosnÄ… w wartoÅ›ci.'
        ],
        'GFC2008': [
          'BaÅ„ka mieszkaniowa i sekurytyzacja subprime maskujÄ… ryzyko.',
          'Marzec 2008: Bear Stearns; rynek krucho stabilny.',
          'WrzesieÅ„ 2008: Lehman; zamarza kredyt, ryzyko kontrahenta eksploduje.',
          'Marzec 2009: QE1; odbicie premiuje jakoÅ›Ä‡ i value.'
        ],
        'COVID2020': [
          'Najszybszy krach w historii â€“ 34% w 23 dni. Ale teÅ¼ najszybsze odbicie.',
          'Fed drukuje biliony. Stopy przy zerze. QE infinity. Money printer go brrr.',
          'Praca zdalna na staÅ‚e â€“ Zoom, Netflix, Amazon wygrywajÄ…. Restauracje cierpiÄ….',
          'Szczepionki zmieniajÄ… narracjÄ™ â€“ rotacja z techu do reopening trade.'
        ],
        'FTX2022': [
          'Luna/UST to algorytmiczny stablecoin â€“ kolapsnÄ…Å‚ w 72h z $40B do $0.',
          '3AC, Celsius, Voyager â€“ wszyscy poÅ¼yczali od siebie. Efekt domina.',
          'FTX uÅ¼ywaÅ‚ depozytÃ³w klientÃ³w jako zabezpieczenia. Alameda Research to hedge fund SBF.',
          'Binance wycofaÅ‚ siÄ™ z przejÄ™cia. Bank run i bankructwo w 48h.'
        ]
      };

      // --------- ROZDZIAÅY I DANE ---------
      const chapters = {
        '1930s': {
          era:'Lata 1930', name:'Wielki Kryzys', desc:'Od Czarnych Dni po Nowy Åad. Zrozum mechanikÄ™ paniki i odbicia.',
          title:'Inwestor Wielkiego Kryzysu',
          subtitle:'Wall Street, jesieÅ„ 1929. Po latach hossy wielu kupuje akcje na kredyt (marÅ¼a). Banki nie majÄ… ubezpieczenia depozytÃ³w, a gospodarka zaczyna siÄ™ potykaÄ‡. W tym rozdziale poznasz margin call, â€odbicie niedÅºwiedzieâ€ i rolÄ™ gotÃ³wki oraz sektorÃ³w defensywnych.',
          indexLabel:'Dow Jones',
          scenarios:[
            { month:'PaÅºdziernik 1929', indexValue:381, title:'ZbliÅ¼a siÄ™ Czarny Czwartek', description:'Gazety od miesiÄ™cy opisujÄ… rekordy. Coraz popularniejsze jest kupowanie akcji na kredyt (marÅ¼a) â€” gdy rynek roÅ›nie, zyski sÄ… powiÄ™kszone, ale gdy spada, broker Å¼Ä…da dopÅ‚aty albo sprzedaje Twoje akcje. KrÄ…Å¼Ä… pogÅ‚oski o kÅ‚opotach w spÃ³Å‚kach i bankach. To moment, w ktÃ³rym drobny bÅ‚Ä…d moÅ¼e wciÄ…gnÄ…Ä‡ caÅ‚y system w lawinÄ™. Co robisz: dokÅ‚adasz paliwa do hossy, czy chronisz kapitaÅ‚?',
              choices:[{text:'Kupuj wiÄ™cej akcji â€“ hossa trwa!',effect:'buy_stocks'},{text:'Sprzedaj wszystko i idÅº w gotÃ³wkÄ™',effect:'sell_all'},{text:'Kup zÅ‚oto jako zabezpieczenie',effect:'buy_gold'},{text:'Graj na spadki â€“ krach nadchodzi',effect:'short_market'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/19/Crowd_outside_nyse.jpg' },
            { month:'Listopad 1929', indexValue:230, title:'Krach siÄ™ rozpoczÄ…Å‚', description:'W kilka dni indeksy spadajÄ… o kilkadziesiÄ…t procent. Uruchamia siÄ™ efekt domina: margin-calle wymuszajÄ… panicznÄ… sprzedaÅ¼, banki bez ubezpieczenia depozytÃ³w same wpadajÄ… w kÅ‚opoty, a klienci ustawiajÄ… siÄ™ w kolejkach po gotÃ³wkÄ™. â€Kup doÅ‚ekâ€ kusi, ale niepewnoÅ›Ä‡ i brak pÅ‚ynnoÅ›ci potrafiÄ… ciÄ…gnÄ…Ä‡ spadki dÅ‚uÅ¼ej, niÅ¼ siÄ™ wydaje rozsÄ…dne.',
              choices:[{text:'Kupuj spadki â€“ tanio!',effect:'buy_dip'},{text:'Czekaj na stabilizacjÄ™',effect:'hold_cash'},{text:'SpÃ³Å‚ki uÅ¼ytecznoÅ›ci publicznej',effect:'buy_utilities'},{text:'Towary i ziemia rolna',effect:'buy_commodities'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5e/New_York_stock_exchange_ticker_tape_parade_1919.jpg' },
            { month:'Czerwiec 1930', indexValue:211, title:'FaÅ‚szywy Å›wit', description:'Po ostrych zjazdach pojawia siÄ™ odbicie â€” klasyczne â€odbicie niedÅºwiedzieâ€. Politycy zapewniajÄ…, Å¼e â€najgorsze za namiâ€, ale podwyÅ¼szone cÅ‚a (Smootâ€“Hawley) uderzajÄ… w handel, a firmy tnÄ… inwestycje i etaty. KrÃ³tkotrwaÅ‚a hossa Å‚atwo wciÄ…ga nieostroÅ¼nych z powrotem na rynek.',
              choices:[{text:'Blue-chipy z dywidendÄ…',effect:'buy_dividends'},{text:'Kopalnie zÅ‚ota',effect:'buy_gold_miners'},{text:'Obligacje rzÄ…dowe',effect:'buy_bonds'},{text:'ZaÅ‚Ã³Å¼ firmÄ™',effect:'start_business'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2a/Construction_New_Deal.jpg' },
            { month:'WrzesieÅ„ 1931', indexValue:130, title:'Depresja siÄ™ pogÅ‚Ä™bia', description:'UpadÅ‚oÅ›ci bankÃ³w i firm mnoÅ¼Ä… siÄ™, bezrobocie roÅ›nie. Ludzie wycofujÄ… gotÃ³wkÄ™, co dodatkowo osÅ‚abia banki â€” spirala siÄ™ zacieÅ›nia. Inwestorzy szukajÄ… bezpieczeÅ„stwa: spÃ³Å‚ek, ktÃ³rych produkty kupuje siÄ™ â€zawszeâ€ (Å¼ywnoÅ›Ä‡, media, uÅ¼ytecznoÅ›Ä‡ publiczna) oraz czystej gotÃ³wki, ktÃ³ra daje moÅ¼liwoÅ›Ä‡ ruchu, gdy pojawi siÄ™ okazja.',
              choices:[{text:'NieruchomoÅ›ci w kryzysie',effect:'buy_real_estate'},{text:'Firmy spoÅ¼ywcze',effect:'buy_staples'},{text:'GromadÅº gotÃ³wkÄ™',effect:'hoard_cash'},{text:'WiÄ™cej zÅ‚ota',effect:'buy_more_gold'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/9c/Breadline.jpg' },
            { month:'Lipiec 1932', indexValue:41, title:'Samo dno', description:'Indeks traci okoÅ‚o 90% od szczytu. Wyceny sÄ… najniÅ¼sze w historii, ale nastroje fatalne. â€Kapitulacjaâ€ oznacza, Å¼e wiÄ™kszoÅ›Ä‡ sprzedaje ze strachu. Kupowanie na dnie bywa zyskowne â€” tylko Å¼e nikt nie wie, Å¼e to dno, dopÃ³ki nie minie. Selekcja jakoÅ›ci ma kluczowe znaczenie.',
              choices:[{text:'All-in w akcje',effect:'buy_bottom'},{text:'Silne spÃ³Å‚ki (IBM)',effect:'buy_quality'},{text:'Akcje alkoholowe',effect:'buy_alcohol'},{text:'ZostaÅ„ przy gotÃ³wce',effect:'stay_safe'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/14/Newspaper_boy_1930s.jpg' },
            { month:'Marzec 1933', indexValue:63, title:'Nowy Åad', description:'Prezydent ogÅ‚asza â€bank holidayâ€ â€” banki na kilka dni sÄ… zamkniÄ™te, system zostaje uporzÄ…dkowany, wchodzi ubezpieczenie depozytÃ³w. Programy robÃ³t publicznych i dewaluacja dolara wspierajÄ… gospodarkÄ™ i ceny zÅ‚ota. To pierwszy wiarygodny sygnaÅ‚, Å¼e dno jest juÅ¼ za nami.',
              choices:[{text:'Infrastruktura',effect:'buy_infrastructure'},{text:'Sprzedaj zÅ‚oto (ryzyko regulacji)',effect:'sell_gold'},{text:'Rolnictwo',effect:'buy_agriculture'},{text:'Koleje',effect:'buy_railroads'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/1a/CCC-workers.jpg' }
          ],
          stockPrices:{ 'General Electric':[396,168,134,85,34,58], 'AT&T':[304,197,178,144,110,136], 'US Steel':[262,150,88,54,22,43], 'ZÅ‚oto':[20.67,20.67,20.67,20.67,35.00,35.00], 'Coca-Cola':[78,45,56,62,48,67], 'IBM':[211,98,67,45,78,124] }
        },

        '1970s': {
          era:'Lata 1970', name:'Kryzys Naftowy i Stagflacja', desc:'Embargo OPEC, inflacja i recesje. Jak chroniÄ‡ realnÄ… wartoÅ›Ä‡?',
          title:'Inwestor Kryzysu Naftowego',
          subtitle:'Lata 70. to szkoÅ‚a przetrwania: ceny ropy rosnÄ… jak szalone, inflacja wysysa siÅ‚Ä™ nabywczÄ…, a gospodarka zwalnia. Zobaczysz, kto korzysta na drogim paliwie, a kto cierpi â€” i jak myÅ›leÄ‡ o ochronie oszczÄ™dnoÅ›ci.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'PaÅºdziernik 1973', indexValue:108, title:'Wojna Yom Kippur', description:'OPEC ogranicza wydobycie i eksport. Cena ropy skacze wielokrotnie; na stacjach ustawiajÄ… siÄ™ kolejki, a koszt transportu i produkcji roÅ›nie niemal wszÄ™dzie. To szok podaÅ¼owy: mniej towaru â†’ wyÅ¼sze ceny. Firmy paliwowe i wÅ‚aÅ›ciciele surowcÃ³w zarabiajÄ…, a linie lotnicze i logistyka dostajÄ… cios.',
              choices:[{text:'Kup spÃ³Å‚ki naftowe',effect:'buy_oil'},{text:'Short na transport',effect:'short_transport'},{text:'Energia alternatywna',effect:'buy_alt_energy'},{text:'ZÅ‚oto i towary',effect:'buy_commodities_70s'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/0/0a/Gas_station_line2.jpg' },
            { month:'Marzec 1974', indexValue:95, title:'Kryzys siÄ™ pogÅ‚Ä™bia', description:'RzÄ…dy prÃ³bujÄ… zamraÅ¼aÄ‡ ceny, co koÅ„czy siÄ™ niedoborami. Inflacja roÅ›nie, a gospodarka hamuje â€” to â€stagflacjaâ€. Dla inwestora oznacza to, Å¼e gotÃ³wka traci siÅ‚Ä™ nabywczÄ…, a zwykÅ‚e obligacje teÅ¼ nie ratujÄ…. ZyskujÄ… biznesy z mocnym â€pricing powerâ€ i infrastruktura energetyczna.',
              choices:[{text:'Infrastruktura energetyczna',effect:'buy_energy_infrastructure'},{text:'Towary podstawowe (staples)',effect:'buy_staples_70s'},{text:'NieruchomoÅ›ci',effect:'buy_real_estate_70s'},{text:'GotÃ³wka',effect:'hold_cash_70s'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/17/Oil_barrel.jpg' },
            { month:'SierpieÅ„ 1974', indexValue:72, title:'Rezygnacja Nixona', description:'Kryzys polityczny zwiÄ™ksza niepewnoÅ›Ä‡, a wysokie stopy procentowe obniÅ¼ajÄ… wyceny spÃ³Å‚ek wzrostowych. Inwestorzy szukajÄ… przystani w dywidendach i metalach szlachetnych. KrÃ³tka sprzedaÅ¼ sektorÃ³w zaleÅ¼nych od taniego finansowania moÅ¼e dziaÅ‚aÄ‡, ale wymaga dyscypliny.',
              choices:[{text:'Dywidendowe defensywy',effect:'buy_dividends_70s'},{text:'Metale szlachetne',effect:'buy_precious_metals'},{text:'Short growth',effect:'short_growth'},{text:'Rynki miÄ™dzynarodowe',effect:'buy_international'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/0/0d/Nixon_Resigns.jpg' },
            { month:'StyczeÅ„ 1975', indexValue:68, title:'Mocna recesja', description:'Bezrobocie siÄ™ga szczytÃ³w. Bank centralny zaczyna luzowaÄ‡ politykÄ™, ale inflacja nadal wysoka. â€JakoÅ›Ä‡ po przecenieâ€ czÄ™sto wygrywa w kolejnych latach. RealnÄ… wartoÅ›Ä‡ pomagajÄ… chroniÄ‡ aktywa rosnÄ…ce z inflacjÄ… (czÄ™Å›Ä‡ towarÃ³w, nieruchomoÅ›ci) i obligacje indeksowane inflacjÄ….',
              choices:[{text:'JakoÅ›Ä‡ po przecenie',effect:'buy_quality_70s'},{text:'Tech efektywnoÅ›ciowy',effect:'buy_efficiency_tech'},{text:'Rolnictwo',effect:'buy_agriculture_70s'},{text:'Inflation-linked',effect:'buy_tips'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2e/Unemployment_line_1970s.jpg' },
            { month:'Lipiec 1976', indexValue:104, title:'Dwustulecie', description:'Gospodarka Å‚apie oddech. Firmy inwestujÄ… w oszczÄ™dnoÅ›Ä‡ energii i automatyzacjÄ™; do przemysÅ‚u wchodzÄ… mikroprocesory. Innowacje potrafiÄ… poprawiÄ‡ produktywnoÅ›Ä‡ nawet w trudnych czasach kosztowych.',
              choices:[{text:'Wczesny tech',effect:'buy_tech_70s'},{text:'OszczÄ™dzanie energii',effect:'buy_conservation'},{text:'Dobra konsumpcyjne',effect:'buy_consumer_disc'},{text:'ZostaÅ„ w towarach',effect:'stay_commodities'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/53/Microprocessor.jpg' },
            { month:'GrudzieÅ„ 1978', indexValue:96, title:'Drugi szok naftowy', description:'NapiÄ™cia na Bliskim Wschodzie ponownie ograniczajÄ… podaÅ¼ ropy. Inflacja rozkrÄ™ca siÄ™, a rynki zaczynajÄ… dyskontowaÄ‡ ostrzejszÄ… politykÄ™ pieniÄ™Å¼nÄ… w kolejnych latach. Premiowane sÄ… realne aktywa i spÃ³Å‚ki surowcowe; sektory wraÅ¼liwe na stopy dostajÄ… po kieszeni.',
              choices:[{text:'Ponownie: spÃ³Å‚ki naftowe',effect:'buy_oil_again'},{text:'Mocniej w alternatywÄ™',effect:'buy_alt_energy_late'},{text:'Aktywa antyinflacyjne',effect:'buy_inflation_assets'},{text:'Short sektory wraÅ¼liwe na stopy',effect:'short_rates'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/9a/Oil_platform.jpg' }
          ],
          stockPrices:{ 'Exxon Mobil':[52,71,84,78,89,96], 'Texaco':[28,42,38,35,47,52], 'Ford':[65,41,38,33,42,39], 'ZÅ‚oto':[97,154,161,140,125,208], 'IBM':[341,246,238,264,287,354], "McDonald's":[77,52,49,58,71,86] }
        },

        '1990s': {
          era:'Lata 1990', name:'Azja, LTCM i euforia', desc:'Od recesji 1990â€“91 do bÄ…bla internetowego.',
          title:'Inwestor Lata 90.',
          subtitle:'Od â€flight to qualityâ€ po â€donâ€™t fight the Fedâ€: jak rynki reagujÄ… na kryzysy i euforie.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'Listopad 1990', indexValue:324, title:'Recesja po Gulf War buildup', description:'Firmy tnÄ… koszty, kredyt jest drogi, nastroje konsumentÃ³w sÅ‚abnÄ…. UpadÅ‚oÅ›ci instytucji S&L oraz napiÄ™cia wokÃ³Å‚ Zatoki Perskiej zwiÄ™kszajÄ… niepewnoÅ›Ä‡. W takiej fazie defensywy i obligacje skarbowe zwykle trzymajÄ… siÄ™ lepiej niÅ¼ ryzykowne â€wzrostÃ³wkiâ€.',
              choices:[{text:'Kup defensywy i dywidendy',effect:'buy_def_90'},{text:'Czekaj z gotÃ³wkÄ…',effect:'hold_cash_90'},{text:'Kup obligacje skarbowe',effect:'buy_bonds_90'},{text:'Agresywnie tech â€“ PC boom',effect:'buy_pc_90'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/3/3d/Personal_computers_1990s.jpg' },
            { month:'Lipiec 1995', indexValue:560, title:'Soft landing', description:'Po podwyÅ¼kach stÃ³p w 1994 r. gospodarka â€siadaâ€ miÄ™kko: inflacja pod kontrolÄ…, a firmy dziÄ™ki komputerom, internetowi i globalizacji poprawiajÄ… produktywnoÅ›Ä‡. Tanie fundusze indeksowe zdobywajÄ… popularnoÅ›Ä‡ â€” wielu inwestorÃ³w zamiast wybieraÄ‡ pojedyncze spÃ³Å‚ki, kupuje caÅ‚y rynek.',
              choices:[{text:'Szeroki indeks (passive)',effect:'buy_index_95'},{text:'Small-caps value',effect:'buy_scv_95'},{text:'SpÃ³Å‚ki telekom',effect:'buy_telco_95'},{text:'Utrzymaj defensywy',effect:'stay_def_95'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/6/6d/NYSE_trading_floor.jpg' },
            { month:'PaÅºdziernik 1997', indexValue:950, title:'Kryzys azjatycki', description:'Kilka krajÃ³w broni staÅ‚ych kursÃ³w walut, aÅ¼ system pÄ™ka. Firmy zadÅ‚uÅ¼one w dolarze tracÄ… finansowanie, kapitaÅ‚ ucieka do bezpiecznych aktywÃ³w. USA teÅ¼ dostajÄ… rykoszetem, ale silna gospodarka sprawia, Å¼e spadki szybko sÄ… odrabiane â€” klasyczny â€flight to qualityâ€.',
              choices:[{text:'Kup spadki w USA',effect:'buy_dip_97'},{text:'Uciekaj w obligacje',effect:'bonds_97'},{text:'Short EM',effect:'short_em_97'},{text:'Kup zÅ‚oto',effect:'gold_97'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/7/7b/Bangkok_skyline_1997.jpg' },
            { month:'WrzesieÅ„ 1998', indexValue:957, title:'LTCM pÄ™ka', description:'SÅ‚ynny fundusz hedgingowy traci pÅ‚ynnoÅ›Ä‡ na wielkich, lewarowanych pozycjach. Fed koordynuje porozumienie bankÃ³w, by uniknÄ…Ä‡ chaosu. Rynek dostaje lekcjÄ™ o ryzyku dÅºwigni i korelacji â€” a potem zaczyna siÄ™ szybki rajd.',
              choices:[{text:'WejdÅº po interwencji Fed',effect:'buy_after_fed_98'},{text:'PozostaÅ„ w gotÃ³wce',effect:'hold_98'},{text:'Short lewar/finanse',effect:'short_fin_98'},{text:'Kup tech momentum',effect:'buy_momo_98'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/4/49/Alan_Greenspan.jpg' },
            { month:'GrudzieÅ„ 1999', indexValue:1469, title:'Euforia milenijna', description:'Internet â€zmieni wszystkoâ€ â€” tak brzmi narracja. Wyceny wielu mÅ‚odych spÃ³Å‚ek opierajÄ… siÄ™ bardziej na obietnicach niÅ¼ na zyskach. FOMO pcha ceny jeszcze wyÅ¼ej. PamiÄ™taj: na dÅ‚uÅ¼szÄ… metÄ™ zyski i przepÅ‚ywy muszÄ… dogoniÄ‡ opowieÅ›Ä‡.',
              choices:[{text:'All-in w dot-comy',effect:'allin_dotcom_99'},{text:'Rotacja do value',effect:'rot_value_99'},{text:'Rebalans 60/40',effect:'rebal_99'},{text:'Short najdroÅ¼sze spÃ³Å‚ki',effect:'short_hyper_99'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2b/Nasdaq_screen_times_square.jpg' }
          ],
          stockPrices:{ 'Microsoft':[0.9,2.4,4.6,5.2,8.9], 'Cisco':[0.4,1.6,3.1,4.2,7.7], 'General Electric':[1.2,1.7,2.2,2.4,2.8], 'Treasuries (10Y)*':[100,103,106,104,98], 'ZÅ‚oto':[380,385,325,290,290], '* ceny ideowe':['â€”','â€”','â€”','â€”','â€”'] }
        },

        'DotCom': {
          era:'2000â€“2002', name:'BaÅ„ka Dot-com', desc:'Euforia internetowa i bolesne otrzeÅºwienie.',
          title:'Inwestor ery dot-com',
          subtitle:'Zobacz, jak narracja â€nowej ekonomiiâ€ zderzyÅ‚a siÄ™ z brakiem zyskÃ³w â€” i kto przetrwaÅ‚.',
          indexLabel:'NASDAQ',
          scenarios:[
            { month:'Marzec 2000', indexValue:5048, title:'Szczyt euforii', description:'IPO pojawiajÄ… siÄ™ co tydzieÅ„, a wyceny oderwaÅ‚y siÄ™ od rzeczywistoÅ›ci: wiele spÃ³Å‚ek nie ma jeszcze zyskÃ³w ani przepÅ‚ywÃ³w pieniÄ™Å¼nych. Inwestorzy pÅ‚acÄ… za obietnice â€kiedyÅ›â€. NajwiÄ™ksze ryzyko? Zmiana nastroju i wysychanie finansowania.',
              choices:[{text:'Kup kaÅ¼dy debiut',effect:'buy_ipos_00'},{text:'Rotacja do quality tech',effect:'rot_quality_00'},{text:'PowaÅ¼ny rebalans do value',effect:'rot_value_00'},{text:'Short ekstremalne wyceny',effect:'short_extreme_00'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2b/Nasdaq_screen_times_square.jpg' },
            { month:'Listopad 2000', indexValue:3000, title:'Rysa na narracji', description:'Przychody nie rosnÄ… tak szybko, a inwestorzy przestajÄ… wierzyÄ‡ w â€zyski kiedyÅ›â€. KapitaÅ‚ ucieka ze spÃ³Å‚ek bez gotÃ³wki, spread miÄ™dzy quality-tech a resztÄ… siÄ™ otwiera.',
              choices:[{text:'Trzymaj i â€przeczekajâ€',effect:'hold_bag_00'},{text:'PrzesuÅ„ do gotÃ³wki',effect:'move_cash_00'},{text:'Kup tylko profitable tech',effect:'buy_prof_00'},{text:'Hedge opcjami/short ETF',effect:'hedge_00'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/98/Internet_bubble_chart.png' },
            { month:'WrzesieÅ„ 2001', indexValue:1423, title:'Szok 9/11', description:'Zamachy zwiÄ™kszajÄ… niepewnoÅ›Ä‡; popyt na podrÃ³Å¼e i reklamy spada. Polityka pieniÄ™Å¼na Å‚agodzi warunki, ale spekulacyjne nazwy tracÄ… blask.',
              choices:[{text:'Kup obronÄ™ i bezpieczeÅ„stwo',effect:'buy_defense_01'},{text:'Short travel/lotnictwo',effect:'short_travel_01'},{text:'PozostaÅ„ przy gotÃ³wce',effect:'hold_cash_01'},{text:'DowaÅ¼ tech quality',effect:'buy_quality_01'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5c/NYC_9-11_WTC.jpg' },
            { month:'PaÅºdziernik 2002', indexValue:1114, title:'PÃ³Åºne dno', description:'Wiele dot-comÃ³w znika z gieÅ‚dy, zostajÄ… liderzy z prawdziwymi przepÅ‚ywami i przewagami konkurencyjnymi. To moment, w ktÃ³rym selekcja jakoÅ›ci znÃ³w wygrywa.',
              choices:[{text:'Kup liderÃ³w â€“ MSFT, INTC',effect:'buy_leaders_02'},{text:'DowaÅ¼ value/cashflow',effect:'buy_value_02'},{text:'ZostaÅ„ w obligacjach',effect:'stay_bonds_02'},{text:'Spekuluj penny-stocks',effect:'penny_02'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/6/6b/NASDAQ_MarketSite.jpg' }
          ],
          stockPrices:{ 'Cisco':[77,50,15,13], 'Amazon':[75,36,6,15], 'Pets.com':[14,4,0,0], 'Microsoft':[58,34,24,26], 'US 10Y (cena)*':[98,101,108,106], '* gwiazdka':['â€”','â€”','â€”','â€”'] }
        },

        'BlackMonday': {
          era:'1987', name:'Black Monday', desc:'NajwiÄ™kszy jednodniowy krach w historii. Dow Jones -22.6% w jeden dzieÅ„!',
          title:'Inwestor Black Monday',
          subtitle:'19 paÅºdziernika 1987 â€“ najczarniejszy poniedziaÅ‚ek w historii Wall Street. Portfolio insurance i panika wywoÅ‚aÅ‚y lawinÄ™.',
          indexLabel:'Dow Jones',
          scenarios:[
            { month:'SierpieÅ„ 1987', indexValue:2722, title:'Szczyt hossy', description:'Rynek byka trwa od 5 lat. Dow Jones zyskaÅ‚ ponad 40% tylko w tym roku. Popularne stajÄ… siÄ™ â€portfolio insurance" â€“ automatyczne systemy, ktÃ³re sprzedajÄ…, gdy rynek spada. Analitycy ostrzegajÄ… przed przegrzanÄ… gospodarkÄ… i rosnÄ…cymi stopami.',
              choices:[{text:'ZostaÅ„ w indeksie â€“ hossa trwa',effect:'stay_bull_87'},{text:'Zabezpiecz opcjami put',effect:'buy_puts_87'},{text:'Rotacja do obligacji',effect:'rotate_bonds_87'},{text:'Short przez futures',effect:'short_fut_87'}]},
            { month:'16 PaÅºdziernik 1987', indexValue:2246, title:'PiÄ…tek przed krachem', description:'Rynek spada mocno w piÄ…tek. Portfolio insurance aktywuje siÄ™ â€“ automatyczne zlecenia sprzedaÅ¼y zalewajÄ… rynek. Przez weekend media rozgrzewajÄ… atmosferÄ™. Strach narasta.',
              choices:[{text:'Sprzedaj wszystko przed weekendem',effect:'sell_friday_87'},{text:'Kup spadki â€“ przesada',effect:'buy_dip_87'},{text:'Zostaw portfel â€“ to korekta',effect:'hold_87'},{text:'Hedge dodatkowymi puts',effect:'more_puts_87'}]},
            { month:'19 PaÅºdziernik 1987', indexValue:1738, title:'BLACK MONDAY', description:'Dow Jones spada o 22.6% w JEDEN dzieÅ„! Portfolio insurance wywoÅ‚uje spiralÄ™ sprzedaÅ¼y. Systemy komputerowe automatycznie rzucajÄ… akcje, co pogÅ‚Ä™bia panikÄ™. Brokerzy nie nadÄ…Å¼ajÄ… z realizacjÄ… zleceÅ„. To chaos.',
              choices:[{text:'PANIKA â€“ sprzedaj wszystko',effect:'panic_sell_87'},{text:'Kup dno â€“ historyczna okazja',effect:'buy_crash_87'},{text:'Czekaj na stabilizacjÄ™',effect:'wait_stable_87'},{text:'Short dalej â€“ bÄ™dzie gorzej',effect:'short_more_87'}]},
            { month:'GrudzieÅ„ 1987', indexValue:1938, title:'Odbicie po szoku', description:'Fed obniÅ¼a stopy, zapewnia pÅ‚ynnoÅ›Ä‡. Rynek odbija o 11% od doÅ‚ka. Gospodarka fundamentalnie mocna â€“ krach byÅ‚ bardziej techniczny niÅ¼ fundamentalny. Odwaga zostaÅ‚a nagrodzona.',
              choices:[{text:'Kup quality blue chips',effect:'buy_quality_87'},{text:'ZwiÄ™ksz ekspozycjÄ™ na tech',effect:'buy_tech_87'},{text:'PozostaÅ„ w defensywach',effect:'stay_def_87'},{text:'Zachowaj gotÃ³wkÄ™',effect:'keep_cash_87'}]}
          ],
          stockPrices:{ 'IBM':[157,132,103,120], 'Microsoft':[2.1,1.8,1.4,1.6], 'GE':[52,43,33,39], 'ZÅ‚oto':[460,465,480,485], 'Bonds':[100,102,108,106] }
        },

        'GFC2008': {
          era:'2008â€“2009', name:'Wielki Kryzys Finansowy', desc:'BaÅ„ka kredytowa, Lehman, QE i dno 2009.',
          title:'Inwestor 2008',
          subtitle:'Od â€to lokalneâ€ do globalnej paniki: jak dziaÅ‚aÅ‚a dÅºwignia, pÅ‚ynnoÅ›Ä‡ i interwencje.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'SierpieÅ„ 2007', indexValue:1455, title:'Rysa na rynku kredytu', description:'Rynek kredytÃ³w hipotecznych subprime zaczyna pÄ™kaÄ‡. Struktury sekurytyzacyjne maskowaÅ‚y ryzyko, a wyceny MBS stajÄ… siÄ™ niepewne. To wstÄ™p do problemÃ³w pÅ‚ynnoÅ›ciowych.',
              choices:[{text:'Short homebuilders/MBS',effect:'short_mbs_07'},{text:'PrzesuÅ„ do quality',effect:'move_quality_07'},{text:'Ignoruj â€“ â€to lokalneâ€',effect:'ignore_07'},{text:'Kup zÅ‚oto',effect:'gold_07'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/8/8b/Subprime_Mortgage_Crisis_2007.png' },
            { month:'Marzec 2008', indexValue:1276, title:'Bear Stearns przejÄ™ty', description:'Fed pomaga sprzedaÄ‡ Bear Stearns, aby zatrzymaÄ‡ panikÄ™. Rynek Å‚apie krÃ³tkie oddechy, ale problemy strukturalne nie znikajÄ….',
              choices:[{text:'Kup banki â€“ â€krew na ulicachâ€',effect:'buy_banks_08'},{text:'Hedge vega/short finanse',effect:'short_fin_08'},{text:'Uciekaj do gotÃ³wki',effect:'cash_08'},{text:'Kup spÃ³Å‚ki defensywne',effect:'def_08'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/4/46/Bear_Stearns_Headquarters.jpg' },
            { month:'WrzesieÅ„ 2008', indexValue:1204, title:'Lehman upada', description:'ZamroÅ¼enie rynku finansowania hurtowego i eksplozja ryzyka kontrahenta powodujÄ… gwaÅ‚townÄ… wyprzedaÅ¼. Fundusze rynku pieniÄ™Å¼nego â€Å‚amiÄ… dolaraâ€. Schronienia: zÅ‚oto i obligacje.',
              choices:[{text:'Kup indeks â€“ ultra ryzyko',effect:'buy_index_09'},{text:'Kup zÅ‚oto/obligacje',effect:'safe_haven_08'},{text:'Short cykliczne',effect:'short_cyc_08'},{text:'PozostaÅ„ w cash',effect:'stay_cash_08'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Lehman_Brothers_Times_Square_by_David_Shankbone.jpg' },
            { month:'Marzec 2009', indexValue:676, title:'Dno i QE1', description:'Bank centralny uruchamia QE, a firmy z mocnymi bilansami wracajÄ… do Å‚ask. To historyczny punkt zwrotny: rynek zaczyna odbijaÄ‡ od dna.',
              choices:[{text:'All-in quality + indeks',effect:'allin_09'},{text:'Kup value/finanse',effect:'buy_value_09'},{text:'ZostaÅ„ w obligacjach',effect:'stay_bonds_09'},{text:'Czekaj â€“ â€za wczeÅ›nieâ€',effect:'wait_09'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5c/Federal_Reserve_Building.jpg' }
          ],
          stockPrices:{ 'SPY (ETF)':[145,128,120,70], 'Gold':[670,920,890,920], 'JPM':[47,40,25,25], 'Caterpillar':[80,72,35,28], 'US 10Y (cena)*':[99,104,109,108], '* gwiazdka':['â€”','â€”','â€”','â€”'] }
        },

        'COVID2020': {
          era:'2020', name:'Kryzys COVID-19', desc:'Pandemia, lockdowny, QE infinity i najszybsze odbicie w historii.',
          title:'Inwestor pandemii COVID-19',
          subtitle:'Od panicznej wyprzedaÅ¼y po najszybsze odbicie w historii. Technologia kontra turystyka. Praca zdalna zmienia Å›wiat.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'Luty 2020', indexValue:3386, title:'Pierwsze alarmy', description:'WiadomoÅ›ci z Chin o nowym wirusie. WHO ogÅ‚asza pandemiÄ™. Rynki ignorujÄ… â€“ â€to tylko grypa". WÅ‚ochy wprowadzajÄ… lockdown. Pierwsze przypadki w USA. NiepewnoÅ›Ä‡ roÅ›nie, ale indeksy nadal na szczytach.',
              choices:[{text:'Ignoruj â€“ przesada mediÃ³w',effect:'ignore_covid'},{text:'Short linie lotnicze/hotele',effect:'short_travel_covid'},{text:'Kup tech (Zoom, Netflix)',effect:'buy_tech_covid'},{text:'Rotacja do defensywy',effect:'rotate_def_covid'}]},
            { month:'Marzec 2020', indexValue:2237, title:'PANIKA i lockdown', description:'Spadek o 34% w 23 dni â€“ najszybszy krach w historii! Lockdowny globalne. Ludzie zamkniÄ™ci w domach. Restauracje, hotele, linie lotnicze sparaliÅ¼owane. VIX eksploduje do 80. Nikt nie wie, co bÄ™dzie dalej.',
              choices:[{text:'SPRZEDAJ wszystko â€“ koniec Å›wiata',effect:'sell_all_covid'},{text:'Kupuj dno â€“ Fed zadziaÅ‚a',effect:'buy_dip_covid'},{text:'Kup zÅ‚oto i Bitcoin',effect:'buy_safe_haven_covid'},{text:'All-in tech i e-commerce',effect:'allin_tech_covid'}]},
            { month:'Czerwiec 2020', indexValue:3100, title:'Odbicie w ksztaÅ‚cie V', description:'Fed drukuje biliony. QE infinity. Stopy przy zerze. Ludzie siedzÄ… w domach i handlujÄ… na Robinhood. Tech leci w kosmos â€“ Zoom, Tesla, Amazon. â€Stonks only go up". FOMO roÅ›nie.',
              choices:[{text:'Kup meme stocks (Hertz, AMC)',effect:'buy_memes_covid'},{text:'Big Tech (FAANG)',effect:'buy_faang_covid'},{text:'Value â€“ za tanie teraz',effect:'buy_value_covid'},{text:'WeÅº zyski â€“ to baÅ„ka',effect:'take_profits_covid'}]},
            { month:'GrudzieÅ„ 2020', indexValue:3756, title:'Szczepionki i nowa era', description:'Szczepionki zatwierdzone. Nadzieja na powrÃ³t normalnoÅ›ci. Tech nadal mocny. Praca zdalna na staÅ‚e. E-commerce przejÄ…Å‚ Å›wiat. â€Reopening trade" â€“ rotacja do przebitych sektorÃ³w. Co teraz?',
              choices:[{text:'Reopening (linie, hotele)',effect:'buy_reopening_covid'},{text:'ZostaÅ„ w techu',effect:'stay_tech_covid'},{text:'Kryptowaluty â€“ nowa era',effect:'buy_crypto_covid'},{text:'Rebalans 60/40',effect:'rebalance_covid'}]}
          ],
          stockPrices:{ 'Zoom':[107,160,252,450], 'Tesla':[180,120,255,705], 'Boeing':[328,95,185,215], 'Bitcoin':[10000,5000,9500,28000], 'SPY':[338,223,310,375], 'Gold':[1580,1700,1770,1895] }
        },

        'FTX2022': {
          era:'2022', name:'FTX Crypto Crash', desc:'Upadek Terra Luna, 3AC, Celsius i FTX. Krypto zima. Bitcoin -77%.',
          title:'Inwestor krachu krypto 2022',
          subtitle:'Od $69k do $16k. Algorytmiczne stablecoiny, dÅºwignia, efekt domina i Sam Bankman-Fried w areszcie.',
          indexLabel:'Bitcoin',
          scenarios:[
            { month:'Maj 2022', indexValue:30000, title:'Luna/Terra imploduje', description:'UST to algorytmiczny stablecoin â€“ miaÅ‚ trzymaÄ‡ $1 przez arbitraÅ¼ z Luna. Wieloryb sprzedaje $350M UST. Peg siÄ™ Å‚amie. Luna drukuje biliony monet. Spirala Å›mierci. $40B wyparowuje w 72h. Do Kwon znika.',
              choices:[{text:'Short Luna â€“ oczywisty scam',effect:'short_luna'},{text:'Kup dip â€“ â€to tylko FUD"',effect:'buy_luna_dip'},{text:'Sprzedaj wszystkie alts',effect:'sell_alts_luna'},{text:'Trzymaj BTC/ETH only',effect:'hold_majors_luna'}]},
            { month:'Lipiec 2022', indexValue:21000, title:'3AC i Celsius bankrutujÄ…', description:'Three Arrows Capital (3AC) â€“ mega hedge fund â€“ bankrutuje. PoÅ¼yczyÅ‚ miliardy, graÅ‚ z dÅºwigniÄ…. Celsius zamraÅ¼a wypÅ‚aty. Voyager bankrutuje. Wszyscy poÅ¼yczali od siebie. Efekt domina. Nikt nie wie kto jest nastÄ™pny.',
              choices:[{text:'WypÅ‚aÄ‡ wszystko z CEX',effect:'withdraw_cex'},{text:'Short exchange tokens',effect:'short_cex_tokens'},{text:'All-in gotÃ³wka i czekaj',effect:'cash_wait_ftx'},{text:'Kup Bitcoin â€“ tanio',effect:'buy_btc_crash'}]},
            { month:'Listopad 2022', indexValue:17000, title:'FTX IMPLODUJE', description:'CZ (Binance) tweetuje Å¼e sprzedaje FTT. Sam Bankman-Fried (SBF) mÃ³wi â€jesteÅ›my OK". Bank run. Binance ogÅ‚asza przejÄ™cie, potem siÄ™ wycofuje. Okazuje siÄ™: FTX uÅ¼yÅ‚ $10B depozytÃ³w klientÃ³w na spekulacje Alamedy. Bankructwo w 48h. SBF aresztowany.',
              choices:[{text:'PANIKA â€“ sprzedaj wszystko',effect:'panic_ftx'},{text:'Self-custody â€“ not your keys',effect:'self_custody'},{text:'Short wszystkie CEX',effect:'short_all_cex'},{text:'Tether risk â€“ avoid USDT',effect:'avoid_tether'}]},
            { month:'GrudzieÅ„ 2022', indexValue:16500, title:'Kapitulacja i dno', description:'Bitcoin -77% od ATH. Altcoiny -90%. Miners sprzedajÄ…. Magazyny krypto zamykajÄ…. SBF w areszcie. Do Kwon w ukryciu. Regulatorzy atakujÄ…. Wszyscy mÃ³wiÄ… â€krypto umarÅ‚o". Genesis bankrutuje. Ale... fundamenty on-chain mocne.',
              choices:[{text:'All-in BTC â€“ dno stulecia',effect:'allin_btc_dno'},{text:'DCA maÅ‚ymi kwotami',effect:'dca_btc'},{text:'Czekaj na $10k',effect:'wait_10k'},{text:'Nigdy wiÄ™cej krypto',effect:'quit_crypto'}]}
          ],
          stockPrices:{ 'Bitcoin':[30000,21000,17000,16500], 'Ethereum':[2000,1200,1100,1200], 'FTT (FTX Token)':[25,2,1,0], 'Luna':[80,0.0001,0.0001,0.0001], 'Coinbase (COIN)':[110,55,40,35], 'Tether (USDT)':[1.00,0.98,0.99,1.00] }
        }
      };

      // --------- MENU ---------
      function buildMenu(){
        console.log('ğŸ“‹ Building menu...');
        const keys = Object.keys(chapters);
        console.log('ğŸ“š Chapters:', keys);
        const html = keys.map(key => {
          const c = chapters[key];
          return `<article class="chapter-card" data-key="${key}" tabindex="0" role="button" aria-label="${c.era}: ${c.name}">
            <div class="chapter-era">${c.era}</div>
            <div class="chapter-name">${c.name}</div>
            <div class="chapter-description">${c.desc}</div>
          </article>`;
        }).join('');
        dom.chapterSelection.innerHTML = html || '<p>Brak rozdziaÅ‚Ã³w.</p>';

        const cards = dom.chapterSelection.querySelectorAll('.chapter-card');
        console.log('ğŸƒ Found cards:', cards.length);

        cards.forEach(card => {
          card.addEventListener('click', () => {
            console.log('ğŸ¯ Card clicked:', card.dataset.key);
            startChapter(card.dataset.key);
          });
          card.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              console.log('âŒ¨ï¸ Enter pressed on:', card.dataset.key);
              startChapter(card.dataset.key);
            }
          });
        });
        console.log('âœ… Menu built with', cards.length, 'cards');
      }

      // --------- GAME FLOW ---------
      function startChapter(key){
        console.log('ğŸš€ Starting chapter:', key);
        currentChapterKey = key;
        capital = 1000;
        currentScenario = 0;
        decisions = 0;
        capitalHistory = [1000]; // Reset and track starting capital
        achievements = []; // Reset achievements
        const ch = chapters[key];

        if (!ch) {
          console.error('âŒ Chapter not found:', key);
          alert('BÅ‚Ä…d: Nie znaleziono rozdziaÅ‚u ' + key);
          return;
        }

        console.log('ğŸ“– Chapter:', ch.title);

        dom.chapterTitle.textContent = ch.title;
        dom.chapterSubtitle.textContent = ch.subtitle;
        dom.indexLabel.textContent = ch.indexLabel;
        dom.decisions.textContent = decisions;

        // Hide all menus
        console.log('ğŸ™ˆ Hiding menus...');
        dom.mainMenu.classList.add('hidden');
        hideWelcomeScreen();
        hideModal();

        // Show game
        console.log('ğŸ‘ï¸ Showing game area...');
        dom.gameArea.classList.remove('hidden');
        renderScenario();
        updateProgress();
        console.log('âœ… Chapter started!');
      }

      function showMainMenu(){
        dom.gameArea.classList.add('hidden');
        showWelcomeScreen(); // Show welcome screen instead of old menu
      }

      function updateProgress(){ const total = chapters[currentChapterKey].scenarios.length; const pct = Math.min(100, Math.round(((currentScenario)/total)*100)); dom.progressBar.style.width = pct + '%'; }

      function formatPrice(v){ if (typeof v === 'string') return v; if (v >= 10) return '$' + v.toLocaleString(); return '$' + Number(v).toFixed(2); }

      function renderGraphic(chKey){
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        const accent2 = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
        const base = `<svg width="100%" height="90" viewBox="0 0 400 90" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="${accent}"/><stop offset="100%" stop-color="${accent2}"/></linearGradient></defs><rect x="0" y="0" width="400" height="90" fill="none" stroke="rgba(255,255,255,0.06)"/>`;
        const tail = `</svg>`;
        const bull = '<path d="M5,70 C60,40 120,60 170,35 C220,20 280,50 330,30 C360,20 380,25 395,20" fill="none" stroke="url(#g)" stroke-width="3" />';
        const bear = '<path d="M5,20 C60,40 120,25 170,45 C220,60 280,30 330,50 C360,60 380,55 395,62" fill="none" stroke="url(#g)" stroke-width="3" />';
        const oil = '<path d="M60,80 L80,20 L100,80 Z M140,80 L160,25 L180,80 Z M220,80 L240,22 L260,80 Z" fill="url(#g)" opacity="0.8"/>';
        const chip = '<rect x="150" y="20" width="100" height="50" rx="6" stroke="url(#g)" fill="none" stroke-width="3"/><g opacity="0.7"><rect x="145" y="12" width="6" height="16"/><rect x="249" y="12" width="6" height="16"/><rect x="145" y="62" width="6" height="16"/><rect x="249" y="62" width="6" height="16"/></g>';
        const bank = '<rect x="40" y="30" width="320" height="40" rx="4" fill="none" stroke="url(#g)" stroke-width="3"/><path d="M40,30 L200,10 L360,30" stroke="url(#g)" stroke-width="3" fill="none"/>';
        let body = bull; if (chKey==='1930s') body = bear; else if (chKey==='1970s') body = oil; else if (chKey==='1990s') body = chip; else if (chKey==='DotCom') body = bull; else if (chKey==='GFC2008') body = bank;
        return base + body + tail;
      }

      function renderScenario(){
        const ch = chapters[currentChapterKey];
        const s = ch.scenarios[currentScenario];
        dom.capital.textContent = `$${capital.toLocaleString()}`;
        dom.month.textContent = s.month;
        dom.indexValue.textContent = s.indexValue;
        dom.decisions.textContent = decisions;

        const hintText = (hints[currentChapterKey] && hints[currentChapterKey][currentScenario]) || '';

        dom.gameContent.innerHTML = `
          <section class="panel">
            <h3 class="panel-title">${s.title}</h3>
            <div class="scenario-graphic">${renderGraphic(currentChapterKey)}</div>
            <p class="scenario-text">${s.description}</p>
            <div class="choices">
              ${s.choices.map((c,i)=>`<button class="choice-btn" data-idx="${i}">${c.text}</button>`).join('')}
            </div>
            <button class="hint-btn" id="hintBtn" aria-expanded="false" aria-controls="hintBox">ğŸ’¡ WskazÃ³wka</button>
            <div id="hintBox" class="hint-box" aria-hidden="true">${hintText}</div>
          </section>
          <aside class="panel" aria-label="Ceny na rynku">
            <h3 class="panel-title">Ceny na rynku</h3>
            <div class="stock-list">
              ${Object.entries(ch.stockPrices).map(([name, arr]) => `
                <div class="stock-item"><span class="stock-name">${name}</span><span class="stock-price">${formatPrice(arr[currentScenario])}</span></div>
              `).join('')}
            </div>
          </aside>`;

        dom.gameContent.querySelectorAll('.choice-btn').forEach(btn => btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-idx'));
          makeChoice(idx);
        }));

        const hintBtn = document.getElementById('hintBtn');
        const hintBox = document.getElementById('hintBox');
        if (hintBtn && hintBox) {
          hintBtn.addEventListener('click', () => {
            const expanded = hintBtn.getAttribute('aria-expanded') === 'true';
            hintBtn.setAttribute('aria-expanded', String(!expanded));
            hintBox.setAttribute('aria-hidden', String(expanded));
          });
        }
        updateProgress();
      }

      function rng(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

      function calculateResult(effect){
        const R=(min,max)=>rng(min,max); let moneyChange=0, message='', type='neutral';
        const outcomes={
          // 1930s
          buy_stocks:[-600,'KupiÅ‚eÅ› tuÅ¼ przed krachem!','loss'], sell_all:[100,'UniknÄ…Å‚eÅ› krachu â€“ brawo.','profit'], buy_gold:[50,'ZÅ‚oto utrzymaÅ‚o wartoÅ›Ä‡.','profit'], short_market:[400,'DoskonaÅ‚y timing na short!','profit'],
          buy_dip:[-R(250,450),'Spadki jeszcze bolaÅ‚y.','loss'], hold_cash:[R(10,40),'Bezpiecznie, ale nudno.','neutral'], buy_utilities:[R(-40,60),'UÅ¼ytecznoÅ›ci trzymajÄ… siÄ™ lepiej.','neutral'], buy_commodities:[R(-30,80),'Towary mieszane, zaleÅ¼ne od popytu.','neutral'], buy_dividends:[R(-40,90),'Dywidendy amortyzujÄ… spadki.','neutral'], buy_gold_miners:[R(-50,120),'GÃ³rnicy zÅ‚ota zmienni, ale dajÄ… alfÄ™.','neutral'], buy_bonds:[R(20,80),'Obligacje rzÄ…dowe stabilizujÄ….','profit'], start_business:[R(-120,200),'Ryzyko w recesji ogromne.','neutral'], buy_real_estate:[R(-180,120),'RE w depresji bardzo ryzykowne.','loss'], buy_staples:[R(10,90),'Staples bardziej odporne.','profit'], hoard_cash:[R(0,40),'GotÃ³wka krÃ³lem w kryzysie.','neutral'], buy_more_gold:[R(20,90),'ZÅ‚oto trzyma wartoÅ›Ä‡.','profit'], buy_bottom:[R(160,420),'Kupno dna â€“ legenda.','profit'], buy_quality:[R(80,240),'JakoÅ›Ä‡ wychodzi z kryzysu mocniej.','profit'], buy_alcohol:[R(20,120),'â€Sin stocksâ€ bywajÄ… defensywne.','profit'], stay_safe:[R(-10,30),'Bezpiecznie, ale ominiesz odbicie.','neutral'], buy_infrastructure:[R(40,160),'New Deal pompowaÅ‚ inwestycje.','profit'], sell_gold:[R(-60,40),'NiepewnoÅ›Ä‡ co do regulacji.','neutral'], buy_agriculture:[R(20,90),'Wsparcie programÃ³w rolnych.','profit'], buy_railroads:[R(-20,80),'Koleje cykliczne, ale skorzystajÄ… na inwestycjach.','neutral'],
          // 1970s
          buy_oil:[R(250,380),'Energetyka eksplodowaÅ‚a w gÃ³rÄ™.','profit'], short_transport:[R(180,340),'Transport oberwaÅ‚ â€“ zysk.','profit'], buy_alt_energy:[R(-50,180),'Wczesna faza â€” mieszane.','neutral'], buy_commodities_70s:[R(40,140),'Towary hedgujÄ… inflacjÄ™.','profit'], buy_energy_infrastructure:[R(40,150),'RurociÄ…gi/rafinerie zyskujÄ….','profit'], buy_staples_70s:[R(20,100),'Podstawowe dobra trzymajÄ… popyt.','profit'], buy_real_estate_70s:[R(20,120),'NieruchomoÅ›ci jako tarcza.','profit'], hold_cash_70s:[R(-20,20),'Inflacja zjada cash.','loss'], buy_dividends_70s:[R(10,80),'Dywidendy Å‚agodzÄ… bÃ³l.','neutral'], buy_precious_metals:[R(60,180),'ZÅ‚oto/srebro korzystajÄ….','profit'], short_growth:[R(60,160),'WzrostÃ³wki karcone stopami.','profit'], buy_international:[R(-30,120),'Dywersyfikacja bywa pomocna.','neutral'], buy_quality_70s:[R(40,160),'JakoÅ›Ä‡ po przecenie.','profit'], buy_efficiency_tech:[R(20,140),'EfektywnoÅ›Ä‡ kosztowa mile widziana.','profit'], buy_agriculture_70s:[R(20,120),'Rolnictwo korzysta z cen towarÃ³w.','profit'], buy_tips:[R(20,90),'Inflation-linked chroniÄ… realny zwrot.','profit'], buy_tech_70s:[R(-20,120),'Wczesny tech zmienny.','neutral'], buy_conservation:[R(10,120),'OszczÄ™dnoÅ›Ä‡ energii trendem.','profit'], buy_consumer_disc:[R(-40,80),'Dyskrecyjne wraÅ¼liwe na realne dochody.','neutral'], stay_commodities:[R(-20,80),'ZaleÅ¼ne od cyklu; czÄ™Å›ciowo dziaÅ‚a.','neutral'], buy_oil_again:[R(80,200),'Drugi szok naftowy.','profit'], buy_alt_energy_late:[R(-20,140),'Alternatywa roÅ›nie, ale niestabilna.','neutral'], buy_inflation_assets:[R(40,160),'Aktywa antyinflacyjne w cenie.','profit'], short_rates:[R(40,140),'WraÅ¼liwe sektory cierpiÄ….','profit'],
          // 1990s
          buy_def_90:[R(40,120),'Defensywy ochroniÅ‚y portfel.','profit'], hold_cash_90:[R(-20,20),'Inflacja podgryza gotÃ³wkÄ™.','neutral'], buy_bonds_90:[R(30,90),'Spadek stÃ³p pomaga obligacjom.','profit'], buy_pc_90:[R(-60,200),'PC boom nie bez wahaÅ„.','neutral'], buy_index_95:[R(60,140),'Rynek byka wynagradza pasywnych.','profit'], buy_scv_95:[R(40,160),'Small-value dajÄ… radÄ™.','profit'], buy_telco_95:[R(-40,80),'Telco poÅ‚owicznie; uwaga na dÅ‚ug.','neutral'], stay_def_95:[R(-20,40),'Za konserwatywnie â€” mniejszy zysk.','neutral'], buy_dip_97:[R(60,160),'USA odbiÅ‚y szybko.','profit'], bonds_97:[R(10,70),'Bezpieczny parking kapitaÅ‚u.','neutral'], short_em_97:[R(80,220),'EM cierpiaÅ‚y â€” short dziaÅ‚a.','profit'], gold_97:[R(-30,30),'ZÅ‚oto bez fajerwerkÃ³w.','neutral'], buy_after_fed_98:[R(80,200),'Donâ€™t fight the Fed.','profit'], hold_98:[R(-20,30),'Ok, ale przepuÅ›ciÅ‚eÅ› odbicie.','neutral'], short_fin_98:[R(-100,120),'Lewar bywa zdradliwy.','neutral'], buy_momo_98:[R(40,220),'Momentum dziaÅ‚aâ€¦ do czasu.','profit'], allin_dotcom_99:[R(-500,400),'Wysokie ryzyko â€” moÅ¼e zaboleÄ‡.','neutral'], rot_value_99:[R(60,180),'Value gotowe na rotacjÄ™.','profit'], rebal_99:[R(40,120),'Dyscyplina popÅ‚aca.','profit'], short_hyper_99:[R(120,320),'Short bÄ…bla bywa zÅ‚otem.','profit'],
          // DotCom
          buy_ipos_00:[R(-420,220),'IPO czÄ™sto wracajÄ… do ceny emisyjnej.','loss'], rot_quality_00:[R(40,160),'Zyskowne techy przetrwaÅ‚y.','profit'], rot_value_00:[R(60,200),'Value wygrywa w bessie tech.','profit'], short_extreme_00:[R(120,360),'Skrajne wyceny pÄ™kajÄ….','profit'], hold_bag_00:[R(-280,40),'â€DÅ‚ugo-terminowo" zabolaÅ‚o.','loss'], move_cash_00:[R(20,80),'KapitaÅ‚ zachowany.','neutral'], buy_prof_00:[R(-40,140),'Selekcja dziaÅ‚a, ale zmiennoÅ›Ä‡ duÅ¼a.','neutral'], hedge_00:[R(40,120),'Hedge amortyzuje spadki.','profit'], buy_defense_01:[R(40,120),'Kontrakty rzÄ…dowe pomagajÄ….','profit'], short_travel_01:[R(80,200),'Travel pod presjÄ….','profit'], hold_cash_01:[R(-10,40),'Bezpiecznie, ale stracone szanse.','neutral'], buy_quality_01:[R(-40,120),'Selekcja nadal trudna.','neutral'], buy_leaders_02:[R(60,200),'Liderzy wracajÄ… pierwsi.','profit'], buy_value_02:[R(60,180),'Cashflow > marzenia.','profit'], stay_bonds_02:[R(10,60),'Stabilnie, ale niÅ¼szy zwrot.','neutral'], penny_02:[R(-200,200),'Kasyno: ksiÄ™Å¼yc albo zero.','neutral'],
          // Black Monday 1987
          stay_bull_87:[R(-150,50),'KupiÅ‚eÅ› szczyt przed krachem.','loss'], buy_puts_87:[R(180,350),'Opcje put â€“ zabezpieczenie zadziaÅ‚aÅ‚o!','profit'], rotate_bonds_87:[R(40,100),'Obligacje uciekÅ‚y przed burzÄ….','profit'], short_fut_87:[R(200,420),'Short futures â€“ trafiÅ‚eÅ›!','profit'], sell_friday_87:[R(120,200),'DoskonaÅ‚a decyzja â€“ uciekÅ‚eÅ› przed krachem.','profit'], buy_dip_87:[R(-280,80),'Spadki byÅ‚y gÅ‚Ä™bsze niÅ¼ myÅ›laÅ‚eÅ›.','loss'], hold_87:[R(-220,40),'To nie byÅ‚a zwykÅ‚a korekta.','loss'], more_puts_87:[R(280,480),'PodwÃ³jne zabezpieczenie â€“ jackpot!','profit'], panic_sell_87:[R(-150,20),'SprzedaÅ‚eÅ› w panice po najgorszych cenach.','loss'], buy_crash_87:[R(200,450),'Kupno w dniu krachu â€“ legendarny ruch!','profit'], wait_stable_87:[R(60,140),'CierpliwoÅ›Ä‡ popÅ‚aca â€“ kupiÅ‚eÅ› niÅ¼ej.','profit'], short_more_87:[R(-120,180),'Odbicie byÅ‚o szybsze niÅ¼ siÄ™ spodziewaÅ‚eÅ›.','neutral'], buy_quality_87:[R(100,240),'Quality blue chips wrÃ³ciÅ‚y mocno.','profit'], buy_tech_87:[R(80,200),'Tech roÅ›nie â€“ Microsoft na fali.','profit'], stay_def_87:[R(20,80),'Bezpiecznie, ale wolniej.','neutral'], keep_cash_87:[R(-20,40),'PrzegapiÅ‚eÅ› odbicie.','neutral'],
          // GFC 2008
          short_mbs_07:[R(180,400),'KrÃ³tka MBS/housing â€” trafione.','profit'], move_quality_07:[R(20,80),'JakoÅ›Ä‡ daje poduszkÄ™.','neutral'], ignore_07:[R(-140,60),'To nie byÅ‚o â€lokalne".','loss'], gold_07:[R(40,120),'Bezpieczna przystaÅ„.','profit'], buy_banks_08:[R(-260,180),'Za wczeÅ›nie â€” jeszcze spadÅ‚o.','neutral'], short_fin_08:[R(120,360),'Finanse pod presjÄ… â€” zysk.','profit'], cash_08:[R(20,60),'KapitaÅ‚ zachowany.','neutral'], def_08:[R(-40,80),'Defensywy mniej bolÄ….','neutral'], buy_index_09:[R(160,380),'Kupno dna â€” nagrodzone.','profit'], safe_haven_08:[R(40,140),'ZÅ‚oto/obligacje dajÄ… ulgÄ™.','profit'], short_cyc_08:[R(80,220),'Cykliczne cierpiaÅ‚y.','profit'], stay_cash_08:[R(-10,40),'Bezpiecznie, ale przegapisz odbicie.','neutral'], allin_09:[R(220,480),'Historyczny trade Å¼ycia.','profit'], buy_value_09:[R(140,320),'Value/finanse z odbiciem.','profit'], stay_bonds_09:[R(20,80),'Stabilnie, mniejszy zwrot.','neutral'], wait_09:[R(-40,60),'Za dÅ‚ugo czekasz â€” rynek ucieka.','neutral'],
          // COVID 2020
          ignore_covid:[R(-180,40),'To nie byÅ‚a przesada â€“ lockdowny sparaliÅ¼owaÅ‚y Å›wiat.','loss'], short_travel_covid:[R(240,480),'Linie lotnicze i hotele w ruinie â€“ idealny short!','profit'], buy_tech_covid:[R(180,420),'Zoom, Netflix â€“ pandemia ich wynagradza!','profit'], rotate_def_covid:[R(40,100),'Defensywa chroni przed najgorszym.','profit'], sell_all_covid:[R(-80,40),'SprzedaÅ‚eÅ› dno â€“ najszybsze odbicie w historii.','loss'], buy_dip_covid:[R(300,650),'Fed zadrukowuje biliony â€“ genialne kupno!','profit'], buy_safe_haven_covid:[R(120,280),'ZÅ‚oto i Bitcoin wystrzeliÅ‚y.','profit'], allin_tech_covid:[R(280,580),'Tech dominuje â€“ Zoom +600%, Tesla +800%!','profit'], buy_memes_covid:[R(-200,400),'Meme stocks to kasyno â€“ moÅ¼e byÄ‡ wszystko.','neutral'], buy_faang_covid:[R(180,360),'FAANG na szczycie â€“ praca zdalna wygrywa.','profit'], buy_value_covid:[R(40,140),'Value cierpliwie czeka na swojÄ… kolej.','neutral'], take_profits_covid:[R(60,120),'Zdrowy rozsÄ…dek â€“ zyski zabezpieczone.','profit'], buy_reopening_covid:[R(140,320),'Szczepionki = rotacja. Linie i hotele odbijajÄ…!','profit'], stay_tech_covid:[R(80,200),'Tech nadal mocny, ale momentum sÅ‚abnie.','profit'], buy_crypto_covid:[R(180,480),'Bitcoin do $60k â€“ krypto eksploduje!','profit'], rebalance_covid:[R(60,140),'ZrÃ³wnowaÅ¼ony portfel przetrwa kaÅ¼dÄ… burzÄ™.','profit'],
          // FTX 2022
          short_luna:[R(300,600),'Idealny short â€“ Luna do zera!','profit'], buy_luna_dip:[R(-450,50),'â€Do Kwon oszust" â€“ strata 99.9%.','loss'], sell_alts_luna:[R(100,200),'UniknÄ…Å‚eÅ› efektu domina.','profit'], hold_majors_luna:[R(-40,80),'BTC/ETH spadÅ‚y, ale przetrwaÅ‚y.','neutral'], withdraw_cex:[R(120,240),'UratowaÅ‚eÅ› kapitaÅ‚ przed FTX!','profit'], short_cex_tokens:[R(200,450),'FTT, CEL do zera â€“ jackpot!','profit'], cash_wait_ftx:[R(40,100),'Bezpiecznie, czekasz na dno.','neutral'], buy_btc_crash:[R(-80,180),'Jeszcze spadnie, ale dÅ‚ugoterminowo OK.','neutral'], panic_ftx:[R(-120,40),'SprzedaÅ‚eÅ› tuÅ¼ przed odbiciem.','loss'], self_custody:[R(150,300),'Not your keys, not your coins â€“ ocalony!','profit'], short_all_cex:[R(180,380),'Wszystkie gieÅ‚dy w ogniu â€“ profit!','profit'], avoid_tether:[R(60,140),'USDT przetrwaÅ‚, ale ostroÅ¼noÅ›Ä‡ popÅ‚aca.','profit'], allin_btc_dno:[R(250,550),'Bitcoin +300% w rok â€“ legendarne kupno!','profit'], dca_btc:[R(120,280),'Dollar cost averaging dziaÅ‚a.','profit'], wait_10k:[R(-40,60),'CzekaÅ‚eÅ› za dÅ‚ugo â€“ Bitcoin odbiÅ‚.','neutral'], quit_crypto:[R(-80,20),'OdpuÅ›ciÅ‚eÅ› przed najwiÄ™kszym odbiciem.','loss']
        };
        if(outcomes[effect]){ [moneyChange,message,type]=outcomes[effect]; }
        else { moneyChange = R(-100,120); message='Efekt zaleÅ¼y od timingu rynku.'; type = moneyChange>0?'profit':(moneyChange<0?'loss':'neutral'); }
        return { moneyChange, message, type };
      }

      function makeChoice(choiceIndex){
        const ch = chapters[currentChapterKey];
        const s = ch.scenarios[currentScenario];
        const choice = s.choices[choiceIndex];
        const result = calculateResult(choice.effect);
        decisions++;
        capital = Math.max(0, Math.round(capital + result.moneyChange));
        capitalHistory.push(capital); // Track capital after each decision
        showResult(choice, result);
        checkAchievements(result); // Check for unlocked achievements
        setTimeout(()=>{ currentScenario++; if(currentScenario>=ch.scenarios.length) endGame(); else renderScenario(); }, 2200);
      }

      // --------- ACHIEVEMENTS SYSTEM ---------
      const achievementDefinitions = {
        'first_profit': { icon: 'ğŸ’°', name: 'Pierwszy Zysk', desc: 'ZarobiÅ‚ pierwszego dolara' },
        'big_win': { icon: 'ğŸ¯', name: 'Wielka Wygrana', desc: 'Zysk +$500 w jednej decyzji' },
        'survivor': { icon: 'ğŸ’', name: 'Survival', desc: 'UkoÅ„czyÅ‚ epokÄ™ z kapitaÅ‚em powyÅ¼ej startu' },
        'millionaire': { icon: 'ğŸ‘‘', name: 'Milioner', desc: 'OsiÄ…gnÄ…Å‚ $10,000+' },
        'perfect_timing': { icon: 'â°', name: 'Perfect Timing', desc: '3 zyski z rzÄ™du' },
        'risk_taker': { icon: 'ğŸ²', name: 'Ryzykant', desc: 'StraciÅ‚ $500+ w jednej decyzji' },
        'comeback_king': { icon: 'ğŸ”¥', name: 'Comeback King', desc: 'OdrobiÅ‚ straty i wyszedÅ‚ na plus' }
      };

      let profitStreak = 0;

      function checkAchievements(result){
        const unlocked = [];

        // First profit
        if(result.moneyChange > 0 && !achievements.includes('first_profit')){
          unlocked.push('first_profit');
          profitStreak++;
        } else if(result.moneyChange < 0){
          profitStreak = 0;
        } else if(result.moneyChange > 0){
          profitStreak++;
        }

        // Big win
        if(result.moneyChange >= 500 && !achievements.includes('big_win')){
          unlocked.push('big_win');
        }

        // Perfect timing (3 profits in a row)
        if(profitStreak >= 3 && !achievements.includes('perfect_timing')){
          unlocked.push('perfect_timing');
        }

        // Risk taker
        if(result.moneyChange <= -500 && !achievements.includes('risk_taker')){
          unlocked.push('risk_taker');
        }

        // Millionaire
        if(capital >= 10000 && !achievements.includes('millionaire')){
          unlocked.push('millionaire');
        }

        // Add to global achievements
        unlocked.forEach(id => {
          if(!achievements.includes(id)){
            achievements.push(id);
            showAchievementNotification(id);
          }
        });
      }

      function showAchievementNotification(achievementId){
        const ach = achievementDefinitions[achievementId];
        if(!ach) return;

        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
          <div class="achievement-content">
            <span class="achievement-icon">${ach.icon}</span>
            <div>
              <div class="achievement-name">ğŸ–ï¸ ${ach.name}</div>
              <div class="achievement-desc">${ach.desc}</div>
            </div>
          </div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 500);
        }, 3000);
      }

      function showResult(choice, result){
        const panel = document.createElement('div');
        panel.className = 'result-panel';
        panel.innerHTML = `
          <h3 class="panel-title">Wynik decyzji</h3>
          <p><strong>WybraÅ‚eÅ›:</strong> ${choice.text}</p>
          <p class="${result.type}"><strong>Rezultat:</strong> ${result.message}</p>
          <p class="${result.type}"><strong>Zmiana kapitaÅ‚u:</strong> ${result.moneyChange>0?'+':''}${result.moneyChange} $</p>`;
        dom.gameContent.prepend(panel);
        dom.capital.textContent = `$${capital.toLocaleString()}`;
      }

      // --------- CAPITAL CHART ---------
      function renderCapitalChart(){
        if(capitalHistory.length < 2) return '<p style="text-align:center;color:var(--muted);">Brak danych do wykresu</p>';

        const width = 600;
        const height = 180;
        const padding = 40;
        const max = Math.max(...capitalHistory);
        const min = Math.min(...capitalHistory);
        const range = max - min || 1;

        // Calculate points
        const points = capitalHistory.map((val, i) => {
          const x = padding + (i / (capitalHistory.length - 1)) * (width - 2 * padding);
          const y = height - padding - ((val - min) / range) * (height - 2 * padding);
          return `${x},${y}`;
        }).join(' ');

        // Area fill points (add bottom corners)
        const areaPoints = `${padding},${height - padding} ` + points + ` ${width - padding},${height - padding}`;

        const startCap = capitalHistory[0];
        const endCap = capitalHistory[capitalHistory.length - 1];
        const change = endCap - startCap;
        const changePercent = ((change / startCap) * 100).toFixed(1);
        const changeColor = change >= 0 ? 'var(--win)' : 'var(--loss)';

        return `
          <div class="capital-chart">
            <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}">
              <defs>
                <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:var(--accent-2);stop-opacity:0.6" />
                  <stop offset="100%" style="stop-color:var(--accent-2);stop-opacity:0.1" />
                </linearGradient>
              </defs>

              <!-- Grid lines -->
              <line class="chart-grid" x1="${padding}" y1="${padding}" x2="${width - padding}" y2="${padding}" />
              <line class="chart-grid" x1="${padding}" y1="${height/2}" x2="${width - padding}" y2="${height/2}" />
              <line class="chart-grid" x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" />

              <!-- Area -->
              <polygon class="chart-area" points="${areaPoints}" />

              <!-- Line -->
              <polyline class="chart-line" points="${points}" />

              <!-- Labels -->
              <text class="chart-label" x="${padding}" y="${height - 10}">Start: $${startCap.toLocaleString()}</text>
              <text class="chart-label" x="${width - padding - 100}" y="${height - 10}">Koniec: $${endCap.toLocaleString()}</text>
              <text class="chart-label" x="${width/2 - 50}" y="20" fill="${changeColor}" font-weight="bold">${change >= 0 ? '+' : ''}${changePercent}%</text>
            </svg>
          </div>
        `;
      }

      function endGame(){
        console.log('ğŸ Game ended!');
        updateProgress();

        // Check final achievement
        const startCap = capitalHistory[0];
        if(capital > startCap && !achievements.includes('survivor')){
          achievements.push('survivor');
        }

        // Generate achievements HTML
        const achievementsHTML = achievements.length > 0 ? `
          <div style="margin:20px 0;">
            <h3 class="panel-title">ğŸ–ï¸ OsiÄ…gniÄ™cia (${achievements.length})</h3>
            <div class="achievements-grid">
              ${achievements.map(id => {
                const ach = achievementDefinitions[id];
                return ach ? `
                  <div class="achievement-badge">
                    <span class="achievement-badge-icon">${ach.icon}</span>
                    <div class="achievement-badge-name">${ach.name}</div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
        ` : '';

        dom.gameContent.innerHTML = `
          <div class="result-panel">
            <h3 class="panel-title">ğŸ† Koniec rozdziaÅ‚u</h3>
            <p>ÅÄ…czna liczba decyzji: <strong>${decisions}</strong></p>
            <p>KoÅ„cowy kapitaÅ‚: <strong class="${capital >= startCap ? 'profit' : 'loss'}">$${capital.toLocaleString()}</strong></p>

            <h4 style="margin-top:24px;color:var(--accent-2);">ğŸ“ˆ Wykres KapitaÅ‚u</h4>
            ${renderCapitalChart()}

            ${achievementsHTML}

            <div style="display:flex;gap:12px;margin-top:24px;justify-content:center;">
              <button class="restart" id="restartChapter">ğŸ”„ Zagraj ponownie</button>
              <button class="restart" id="backToMenu">ğŸ  WrÃ³Ä‡ do menu</button>
            </div>
          </div>`;

        // Add event listeners to buttons
        const restartBtn = document.getElementById('restartChapter');
        const menuBtn = document.getElementById('backToMenu');

        if (restartBtn) {
          restartBtn.addEventListener('click', () => {
            console.log('ğŸ”„ Restarting chapter:', currentChapterKey);
            startChapter(currentChapterKey);
          });
        }

        if (menuBtn) {
          menuBtn.addEventListener('click', () => {
            console.log('ğŸ  Going back to menu');
            showMainMenu();
          });
        }

        console.log('âœ… End game screen ready');
      }

      // INIT - Initialize everything after DOM loads
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ“„ DOM loaded, initializing game...');
        initMenuSystem();
        console.log('âœ… Game ready!');
      });

      // Also call immediately in case DOMContentLoaded already fired
      if (document.readyState === 'loading') {
        console.log('â³ Waiting for DOM...');
      } else {
        console.log('ğŸ“„ DOM already loaded, initializing now...');
        initMenuSystem();
      }

      // Functions are now used via event listeners, no need to export

    } catch (e) {
      showError(e.message || String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
