<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historyczny Inwestor ‚Äî Wersja Edukacyjna</title>
  <style>
    :root {
      --bg: #0f1222; --panel:#15182a; --text:#eef3ff; --muted:#cbd5e1;
      --accent:#8b5cf6; --accent-2:#22d3ee; --border:#2a2e44;
      --win:#22c55e; --loss:#ef4444; --neutral:#f59e0b; --shadow:rgba(0,0,0,.4);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0; color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(139,92,246,.15), rgba(0,0,0,0) 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(34,211,238,.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #0b0e1a, #0f1222 45%, #0a0c18 100%);
    }
    .container { max-width:1200px; margin:0 auto; padding:24px; }
    .main-menu { text-align:center; padding:48px 16px; }
    .main-title { font-size: clamp(1.8rem,3.8vw,3rem); margin:0 0 8px; font-weight:800; letter-spacing:-.02em; }
    .main-title span { background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .main-subtitle { color:var(--muted); margin:0 0 24px; }
    .chapter-selection { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
    .chapter-card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; padding:20px; text-align:left; cursor:pointer; transition: transform .25s, box-shadow .25s, border-color .25s; box-shadow:0 10px 30px var(--shadow); }
    .chapter-card:hover { transform: translateY(-4px); border-color: rgba(139,92,246,.6); box-shadow:0 16px 40px rgba(34,211,238,.16); }
    .chapter-era { font-weight:800; letter-spacing:.02em; color:var(--accent-2); }
    .chapter-name { font-size:1.25rem; margin:8px 0; font-weight:700; }
    .chapter-description { color:var(--muted); font-size:.95rem; line-height:1.45; }
    .hidden { display:none; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    .back-btn { background: linear-gradient(90deg, rgba(139,92,246,.3), rgba(34,211,238,.3)); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .back-btn:hover { filter:brightness(1.1); transform: translateY(-1px); }
    .progress-outer { width:100%; height:10px; background:#0d1122; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .progress-inner { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .4s ease; }
    .header { display:grid; gap:8px; margin-bottom:16px; }
    .title { font-size: clamp(1.5rem,2.5vw,2.2rem); margin:0; }
    .subtitle { color:var(--muted); margin:0; }
    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px; }
    .stat-card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px 14px; }
    .stat-label { color:var(--muted); font-size:.8rem; }
    .stat-value { font-size:1.25rem; font-weight:800; }
    .layout { display:grid; grid-template-columns:1.08fr .92fr; gap:16px; margin-top:16px; }
    @media (max-width:900px){ .layout{ grid-template-columns:1fr; } }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 30px var(--shadow); }
    .panel-title { margin:0 0 10px; font-size:1.1rem; letter-spacing:.01em; }
    .scenario-text { color:#e6ebff; opacity:.95; line-height:1.6; margin-bottom:14px; }
    .choices { display:grid; gap:10px; }
    .choice-btn { border:1px solid var(--border); background:#1a1d32; color:var(--text); padding:12px 14px; border-radius:12px; text-align:left; cursor:pointer; font-weight:600; transition: transform .18s, border-color .18s, background .18s; }
    .choice-btn:hover { transform: translateY(-1px); border-color: rgba(34,211,238,.6); background:#1e2140; }
    .stock-list { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .stock-item { display:flex; align-items:center; justify-content:space-between; background:#151935; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .stock-name { font-weight:700; }
    .stock-price { color:var(--accent-2); font-variant-numeric: tabular-nums; }
    .result-panel { grid-column:1/-1; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; padding:18px; text-align:center; box-shadow:0 10px 30px var(--shadow); }
    .profit { color:var(--win); font-weight:800; }
    .loss { color:var(--loss); font-weight:800; }
    .neutral { color:var(--neutral); font-weight:800; }
    .restart { display:inline-flex; gap:8px; align-items:center; margin-top:10px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:#0a0c18; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; }
    .restart:hover { filter:brightness(1.05); }
    .hint-btn { background:transparent; color:var(--accent-2); border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .hint-btn:hover { background: rgba(34,211,238,.08); border-color: rgba(34,211,238,.5); transform: translateY(-1px); }
    .hint-box { display:none; margin-top:12px; border-left:3px solid var(--accent-2); padding:12px 14px; color:var(--muted); background: rgba(34,211,238,.08); border-radius:0 10px 10px 0; }
    .hint-box[aria-hidden="false"] { display:block; }
    .scenario-graphic { margin:8px 0 12px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .photo { margin-top:8px; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .photo img { display:block; width:100%; height:auto; }
    .error { margin:16px 0; color:#fecaca; background:#7f1d1d; border:1px solid #991b1b; padding:10px 12px; border-radius:10px; display:none; }
    .hidden { display:none !important; }

    /* NOWE STYLE DLA MENU */
    .game-cover-logo { width:100%; max-width:400px; margin:0 auto 30px; }
    .game-cover-logo img { width:100%; height:auto; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.6); border:3px solid var(--accent-2); transition: transform .3s ease; }
    .game-cover-logo img:hover { transform: scale(1.02); box-shadow:0 25px 70px rgba(139,92,246,0.4); }
    .menu-buttons-container { display:flex; flex-direction:column; gap:16px; max-width:500px; margin:24px auto 0; }
    .menu-main-btn { padding:18px 32px; font-size:1.2rem; font-weight:700; border:none; border-radius:12px; cursor:pointer; transition: all .3s ease; text-align:center; }
    .menu-main-btn:hover { transform: translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,.3); }
    .primary-btn { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0a0c18; }
    .primary-btn:hover { filter:brightness(1.1); }
    .secondary-btn { background: linear-gradient(135deg, rgba(139,92,246,.3), rgba(34,211,238,.3)); border:1px solid var(--border); color:var(--text); }
    .secondary-btn:hover { background: linear-gradient(135deg, rgba(139,92,246,.4), rgba(34,211,238,.4)); border-color: var(--accent-2); }
    .tertiary-btn { background:transparent; border:1px solid var(--border); color:var(--text); }
    .tertiary-btn:hover { background: rgba(255,255,255,.05); border-color: var(--accent); }

    /* MODAL */
    .epoch-modal { position:fixed; top:0; left:0; width:100%; height:100vh; z-index:9999; display:flex; align-items:center; justify-content:center; }
    .modal-backdrop { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.85); backdrop-filter:blur(8px); }
    .modal-box { position:relative; z-index:10000; background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:32px; max-width:1100px; max-height:85vh; overflow-y:auto; box-shadow:0 25px 80px rgba(0,0,0,.8); }
    .modal-title { font-size:2.2rem; margin:0 0 8px; text-align:center; background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .modal-subtitle { text-align:center; color:var(--muted); margin:0 0 24px; font-size:1.05rem; }
    .modal-close { display:block; margin:24px auto 0; padding:12px 32px; background: linear-gradient(135deg, #e74c3c, #c0392b); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:1.1rem; transition: all .3s ease; }
    .modal-close:hover { transform: translateY(-2px); box-shadow:0 8px 20px rgba(231,76,60,.5); }
    .modal-box::-webkit-scrollbar { width:10px; }
    .modal-box::-webkit-scrollbar-track { background:rgba(255,255,255,.05); border-radius:10px; }
    .modal-box::-webkit-scrollbar-thumb { background:var(--accent-2); border-radius:10px; }
    .modal-box::-webkit-scrollbar-thumb:hover { background:var(--accent); }

    /* ACHIEVEMENT NOTIFICATIONS */
    .achievement-notification { position:fixed; top:20px; right:-400px; background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.95)); backdrop-filter:blur(10px); padding:16px 20px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.5); z-index:10001; transition: right .5s ease; min-width:300px; border:2px solid var(--gold); }
    .achievement-notification.show { right:20px; }
    .achievement-content { display:flex; align-items:center; gap:12px; }
    .achievement-icon { font-size:2.5rem; }
    .achievement-name { font-weight:800; font-size:1.1rem; color:#fff; }
    .achievement-desc { font-size:0.9rem; color:#eef; opacity:0.9; }

    /* CAPITAL CHART */
    .capital-chart { width:100%; height:200px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; margin:20px 0; }
    .chart-line { stroke:var(--accent-2); stroke-width:3; fill:none; }
    .chart-area { fill:url(#chartGradient); opacity:0.3; }
    .chart-grid { stroke:rgba(255,255,255,0.1); stroke-width:1; }
    .chart-label { fill:var(--muted); font-size:12px; }

    /* ACHIEVEMENTS DISPLAY */
    .achievements-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin:16px 0; }
    .achievement-badge { background:rgba(139,92,246,0.2); border:1px solid var(--border); border-radius:10px; padding:12px; text-align:center; }
    .achievement-badge-icon { font-size:2rem; display:block; margin-bottom:6px; }
    .achievement-badge-name { font-size:0.85rem; font-weight:700; color:var(--text); }
  </style>
<script type="text/javascript" nonce="fbaf3247a48d4e4a8f9106ab1e1" src="//local.adguard.org?ts=1754656650365&amp;type=content-script&amp;dmn=mail-attachment.googleusercontent.com&amp;url=https%3A%2F%2Fmail-attachment.googleusercontent.com%2Fattachment%2Fu%2F0%2F%3Fui%3D2%26ik%3Df2ae618626%26attid%3D0.1%26permmsgid%3Dmsg-a%3Ar1370544206735525610%26th%3D19889e3900ffb5b5%26view%3Datt%26disp%3Dsafe%26realattid%3Df_me2v9lx50%26zw%26saddbat%3DANGjdJ9tnBx_fnmLD0gV18C3e8AnDwqW-CBoSG5TniDTP7IlJxdF3c7fYm1JqWHOp1e2U9TvLYbN-S64edVSp36JLaz7lgEc4vSYRpervdKBj2MWW2Ntn3HBxZVgr9bHNRnIC2GH-o-aTVqiITTbwjK6m35XDD3sTWXR9z6IIFLWdTv9OMC80sMRwu7aSEIuiCvfHTPm_eiGFWgoLnWc-VZkHCw4JXkL0q5t3iNEwoJVjtwnwRhPB3zRA51A6WN91SU_ZnAsTCRiPXd0Msyv2fRmUcHn2k_sopUnWRhtgY5u_VoQoIX030s-Zcuh0zJo6TKagK77NwE-bfelFjigt7DCc31dXx7WGPV7smw7gaUr9YHpDXAueoQIoLQWRedXTPQRiufiugXAnck0-1NRrGAAqW6p5j4FObQXhuFeE9Mh2j8tSo-HV-wluEhwmBT87d7Xy1OOu_-rSgkdbiOk-yHROdxp3tVK8Iyge5fA6Zc88exedhQbCKYDWlU7j8wGlblf5BWObkyVKv0kUmKz7iLM1nYMdzMFFHjkEQiVWG7tT6XqnDDI-vpY4je5GRtV0qwUPxb2C9NoXTzqoNVbua0ZXTQgzJHq9W6Y6N7dgMxIJE2DuZzrreT27qAi495WlA2N0h2A_zI4Fy1Hv5PPyJ96DmfPAk4j2i1q0CCSybCT3BbeKkMOI0rgyyxRbq8UzouKTlOtpAgzrrhBDUAn-wn82BdpK5DrhOnMFii0TuNUuTPPAsjJSS5klGGZDS3O-pSyP0ag3oJg4nEAnIC52JuNpOYISp4vEefezHjrMPn74LnIR9D5SsIlpkm1ZCf-Tk2YtKz8kaMOlL-1MatxeXXR0wxxXNrKVCbffgEDVQ4xWilbjmLE_MvNdd0WafGDjkvVXEf_pWTOZJhp6HV0N5B7ViNarFcExpGJdq2Ebas0Hp1jI-es8lrVhvlv1eFF5SDbsXbsVf8Vb8fKZ5QKHMtA0fjL7-mrWSHXlr0V0Rt9uNKCqAIJ_4EF3mEEVWs0pHlUZyEG237H9Y-IHB1zAGy1gACIP5KpIx2yqPXf643aBfFM_Teq1mO7VZXxz3L4wYcnniaZ13f-PqnnMixv&amp;app=chrome.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="fbaf3247a48d4e4a8f9106ab1e1" src="//local.adguard.org?ts=1754656650365&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script></head>
<body>
  <div class="container">
    <!-- EKRAN POWITALNY Z GUZIKAMI -->
    <section id="welcomeScreen" class="main-menu" aria-labelledby="welcomeHeading">
      <div class="game-cover-logo">
        <img src="kochampatronow_okadka_gry_dla_inwestora_giedowego_z_elementam_1f221263-b989-4da4-8eb4-42536d07774d.png" alt="Historyczny Inwestor - Ok≈Çadka">
      </div>
      <h1 id="welcomeHeading" class="main-title">Historyczny <span>Inwestor</span></h1>
      <p class="main-subtitle">Przetrwaj najwiƒôksze wstrzƒÖsy rynkowe i zrozum, co siƒô wtedy dzia≈Ço ‚Äî krok po kroku.</p>
      <div class="menu-buttons-container">
        <button class="menu-main-btn primary-btn" id="quickStartBtn">üéÆ Szybki Start</button>
        <button class="menu-main-btn secondary-btn" id="chooseEpochBtn">üï∞Ô∏è Wybierz Epokƒô</button>
        <button class="menu-main-btn tertiary-btn" id="aboutBtn">‚ÑπÔ∏è O Grze</button>
      </div>
    </section>

    <!-- MODAL WYBORU EPOKI -->
    <div id="epochModal" class="epoch-modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-backdrop" id="modalBackdrop"></div>
      <div class="modal-box">
        <h2 id="modalTitle" class="modal-title">üï∞Ô∏è Wybierz Epokƒô HistorycznƒÖ</h2>
        <p class="modal-subtitle">Zacznij swojƒÖ przygodƒô od wybranego kryzysu finansowego</p>
        <div id="errorBox" class="error"></div>
        <div class="chapter-selection" id="chapterSelection"></div>
        <button class="modal-close" id="closeModalBtn" aria-label="Zamknij">‚ùå Zamknij</button>
      </div>
    </div>

    <!-- STARE MENU (teraz ukryte, u≈ºywane tylko przez modal) -->
    <section id="mainMenu" class="hidden" aria-labelledby="menuHeading">
      <h1 id="menuHeading" class="main-title">Historyczny <span>Inwestor</span></h1>
      <p class="main-subtitle">Przetrwaj najwiƒôksze wstrzƒÖsy rynkowe i zrozum, co siƒô wtedy dzia≈Ço ‚Äî krok po kroku.</p>
    </section>

    <section id="gameArea" class="hidden" aria-live="polite">
      <div class="topbar">
        <button class="back-btn" id="backBtn" aria-label="Wr√≥ƒá do menu">‚Üê Powr√≥t</button>
        <div class="progress-outer" aria-hidden="true"><div id="progressBar" class="progress-inner"></div></div>
      </div>

      <header class="header">
        <h2 id="chapterTitle" class="title">‚Äî</h2>
        <p id="chapterSubtitle" class="subtitle">‚Äî</p>
        <div class="stats" role="group" aria-label="Statystyki gry">
          <div class="stat-card"><div class="stat-label">Kapita≈Ç</div><div id="capital" class="stat-value">$1,000</div></div>
          <div class="stat-card"><div class="stat-label">Okres</div><div id="month" class="stat-value">‚Äî</div></div>
          <div class="stat-card"><div id="indexLabel" class="stat-label">Indeks</div><div id="indexValue" class="stat-value">‚Äî</div></div>
          <div class="stat-card"><div class="stat-label">Decyzje</div><div id="decisions" class="stat-value">0</div></div>
        </div>
      </header>

      <div class="layout" id="gameContent"></div>
    </section>
  </div>

  <script>
  (function(){
    const errorBox = document.getElementById('errorBox');
    function showError(msg){
      errorBox.textContent = 'B≈ÇƒÖd skryptu: ' + msg;
      errorBox.style.display = 'block';
    }

    try {
      // --------- STATE ---------
      let currentChapterKey = null;
      let capital = 1000;
      let currentScenario = 0;
      let decisions = 0;
      let capitalHistory = []; // Track capital over time
      let achievements = []; // Track unlocked achievements

      const dom = {
        mainMenu: document.getElementById('mainMenu'),
        gameArea: document.getElementById('gameArea'),
        chapterTitle: document.getElementById('chapterTitle'),
        chapterSubtitle: document.getElementById('chapterSubtitle'),
        indexLabel: document.getElementById('indexLabel'),
        capital: document.getElementById('capital'),
        month: document.getElementById('month'),
        indexValue: document.getElementById('indexValue'),
        decisions: document.getElementById('decisions'),
        gameContent: document.getElementById('gameContent'),
        chapterSelection: document.getElementById('chapterSelection'),
        backBtn: document.getElementById('backBtn'),
        progressBar: document.getElementById('progressBar')
      };

      // --------- MENU SYSTEM ---------
      const welcomeScreen = document.getElementById('welcomeScreen');
      const epochModal = document.getElementById('epochModal');
      const quickStartBtn = document.getElementById('quickStartBtn');
      const chooseEpochBtn = document.getElementById('chooseEpochBtn');
      const aboutBtn = document.getElementById('aboutBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const modalBackdrop = document.getElementById('modalBackdrop');

      function showWelcomeScreen(){
        welcomeScreen.classList.remove('hidden');
        dom.gameArea.classList.add('hidden');
        epochModal.classList.add('hidden');
      }

      function hideWelcomeScreen(){
        welcomeScreen.classList.add('hidden');
      }

      function showModal(){
        console.log('üé≠ Opening modal...');
        epochModal.classList.remove('hidden');
        console.log('üì¶ chapterSelection element:', dom.chapterSelection);
        buildMenu(); // Populate modal with chapters
        console.log('‚úÖ Modal opened');
      }

      function hideModal(){
        epochModal.classList.add('hidden');
      }

      // Initialize menu system AFTER DOM loads
      function initMenuSystem(){
        console.log('üéÆ Initializing menu system...');

        dom.backBtn.addEventListener('click', () => {
          console.log('Back button clicked');
          showWelcomeScreen();
        });

        quickStartBtn.addEventListener('click', () => {
          console.log('Quick start clicked');
          hideWelcomeScreen();
          startChapter('1930s');
        });

        chooseEpochBtn.addEventListener('click', () => {
          console.log('Choose epoch clicked');
          showModal();
        });

        aboutBtn.addEventListener('click', () => {
          console.log('About clicked');
          alert('üìà HISTORYCZNY INWESTOR - Wersja Edukacyjna\n\nWciel siƒô w rolƒô inwestora prze≈ºywajƒÖcego najwiƒôksze kryzysy finansowe ostatnich 100 lat.\n\nüéØ Cel: Zrozum mechanizmy rynkowe i naucz siƒô podejmowaƒá mƒÖdre decyzje\nüìö 5 Epok: Od Wielkiego Kryzysu 1929 do Kryzysu Finansowego 2008\nüí° Ucz siƒô na b≈Çƒôdach historii!\n\nWersja: 3.0-complete');
        });

        closeModalBtn.addEventListener('click', () => {
          console.log('Close modal clicked');
          hideModal();
        });

        modalBackdrop.addEventListener('click', () => {
          console.log('Backdrop clicked');
          hideModal();
        });

        console.log('‚úÖ Menu system initialized');
      }

      // --------- HINTS (obszerne t≈Ça historyczne ‚Äî ukryte do klikniƒôcia) ---------
      const hints = {
        '1930s': [
          'Czarny Czwartek/Wtorek (1929) uruchamia lawinƒô margin-calli. Standard z≈Çota ogranicza elastyczno≈õƒá banku centralnego. Brak ubezpieczenia depozyt√≥w pog≈Çƒôbia panikƒô.',
          'Smoot‚ÄìHawley ogranicza handel; popyt s≈Çabnie, deflacja zwiƒôksza realny ciƒô≈ºar d≈Çug√≥w.',
          '‚ÄûOdbicia nied≈∫wiedzie‚Äù kuszƒÖ, ale fundamenty s≈ÇabnƒÖ.',
          'Fale bankructw i bezrobocie. Przewagƒô majƒÖ defensywy i got√≥wka.',
          'Lato 1932 ‚Äì historyczne dno; kupowanie jako≈õci nagradzane, ale ryzyko nadal wysokie.',
          '1933: Bank holiday, FDIC, programy publiczne i dewaluacja dolara stabilizujƒÖ system.'
        ],
        '1970s': [
          'Embargo OPEC (1973) winduje ceny ropy; szok poda≈ºowy i poczƒÖtek stagflacji.',
          'Limity cen ‚Üí niedobory; got√≥wka i zwyk≈Çe obligacje przegrywajƒÖ z inflacjƒÖ.',
          'Watergate i wysokie stopy: przewagƒô majƒÖ dywidendy i metale szlachetne.',
          'Recesja 1974‚Äì75; ‚Äûjako≈õƒá po przecenie‚Äù bywa nagradzana.',
          'Wydajno≈õƒá ro≈õnie dziƒôki oszczƒôdzaniu energii i automatyzacji.',
          '1979: drugi szok naftowy i wy≈ºsza inflacja.'
        ],
        '1990s': [
          'Recesja na starcie dekady, problemy S&L, Gulf War ‚Äì defensywy w cenie.',
          '1994‚Äì96: ‚Äûsoft landing‚Äù; produktywno≈õƒá ro≈õnie dziƒôki IT i globalizacji.',
          '1997: kryzys azjatycki ‚Äì ‚Äûflight to quality‚Äù.',
          '1998: LTCM, d≈∫wignia i korelacje; ‚Äûdon‚Äôt fight the Fed‚Äù.',
          '1999: euforia internetowa ‚Äì uwaga na rozjazd wycen i zysk√≥w.'
        ],
        'DotCom': [
          '2000: kulminacja bƒÖbla; wiele sp√≥≈Çek bez zysk√≥w, szybkie IPO.',
          'P≈Çynno≈õƒá wysycha; quality-tech trzyma siƒô lepiej.',
          '9/11: szok popytowy; polityka pieniƒô≈ºna ≈Çagodzi skutki.',
          '2002: p√≥≈∫ne dno; zostajƒÖ liderzy z got√≥wkƒÖ i moatami.'
        ],
        'BlackMonday': [
          'Portfolio insurance to automatyczne systemy sprzeda≈ºy ‚Äì gdy rynek spada, automatycznie dosprzedajƒÖ.',
          'Fed szybko reaguje ‚Äì obni≈ºa stopy i zapewnia p≈Çynno≈õƒá. To zapobiega recesji.',
          'Krach by≈Ç bardziej techniczny ni≈º fundamentalny ‚Äì gospodarka USA mocna.',
          'Opcje put to zabezpieczenie ‚Äì gdy rynek spada, rosnƒÖ w warto≈õci.'
        ],
        'GFC2008': [
          'Ba≈Ñka mieszkaniowa i sekurytyzacja subprime maskujƒÖ ryzyko.',
          'Marzec 2008: Bear Stearns; rynek krucho stabilny.',
          'Wrzesie≈Ñ 2008: Lehman; zamarza kredyt, ryzyko kontrahenta eksploduje.',
          'Marzec 2009: QE1; odbicie premiuje jako≈õƒá i value.'
        ]
      };

      // --------- ROZDZIA≈ÅY I DANE ---------
      const chapters = {
        '1930s': {
          era:'Lata 1930', name:'Wielki Kryzys', desc:'Od Czarnych Dni po Nowy ≈Åad. Zrozum mechanikƒô paniki i odbicia.',
          title:'Inwestor Wielkiego Kryzysu',
          subtitle:'Wall Street, jesie≈Ñ 1929. Po latach hossy wielu kupuje akcje na kredyt (mar≈ºa). Banki nie majƒÖ ubezpieczenia depozyt√≥w, a gospodarka zaczyna siƒô potykaƒá. W tym rozdziale poznasz margin call, ‚Äûodbicie nied≈∫wiedzie‚Äù i rolƒô got√≥wki oraz sektor√≥w defensywnych.',
          indexLabel:'Dow Jones',
          scenarios:[
            { month:'Pa≈∫dziernik 1929', indexValue:381, title:'Zbli≈ºa siƒô Czarny Czwartek', description:'Gazety od miesiƒôcy opisujƒÖ rekordy. Coraz popularniejsze jest kupowanie akcji na kredyt (mar≈ºa) ‚Äî gdy rynek ro≈õnie, zyski sƒÖ powiƒôkszone, ale gdy spada, broker ≈ºƒÖda dop≈Çaty albo sprzedaje Twoje akcje. KrƒÖ≈ºƒÖ pog≈Çoski o k≈Çopotach w sp√≥≈Çkach i bankach. To moment, w kt√≥rym drobny b≈ÇƒÖd mo≈ºe wciƒÖgnƒÖƒá ca≈Çy system w lawinƒô. Co robisz: dok≈Çadasz paliwa do hossy, czy chronisz kapita≈Ç?',
              choices:[{text:'Kupuj wiƒôcej akcji ‚Äì hossa trwa!',effect:'buy_stocks'},{text:'Sprzedaj wszystko i id≈∫ w got√≥wkƒô',effect:'sell_all'},{text:'Kup z≈Çoto jako zabezpieczenie',effect:'buy_gold'},{text:'Graj na spadki ‚Äì krach nadchodzi',effect:'short_market'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/19/Crowd_outside_nyse.jpg' },
            { month:'Listopad 1929', indexValue:230, title:'Krach siƒô rozpoczƒÖ≈Ç', description:'W kilka dni indeksy spadajƒÖ o kilkadziesiƒÖt procent. Uruchamia siƒô efekt domina: margin-calle wymuszajƒÖ panicznƒÖ sprzeda≈º, banki bez ubezpieczenia depozyt√≥w same wpadajƒÖ w k≈Çopoty, a klienci ustawiajƒÖ siƒô w kolejkach po got√≥wkƒô. ‚ÄûKup do≈Çek‚Äù kusi, ale niepewno≈õƒá i brak p≈Çynno≈õci potrafiƒÖ ciƒÖgnƒÖƒá spadki d≈Çu≈ºej, ni≈º siƒô wydaje rozsƒÖdne.',
              choices:[{text:'Kupuj spadki ‚Äì tanio!',effect:'buy_dip'},{text:'Czekaj na stabilizacjƒô',effect:'hold_cash'},{text:'Sp√≥≈Çki u≈ºyteczno≈õci publicznej',effect:'buy_utilities'},{text:'Towary i ziemia rolna',effect:'buy_commodities'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5e/New_York_stock_exchange_ticker_tape_parade_1919.jpg' },
            { month:'Czerwiec 1930', indexValue:211, title:'Fa≈Çszywy ≈õwit', description:'Po ostrych zjazdach pojawia siƒô odbicie ‚Äî klasyczne ‚Äûodbicie nied≈∫wiedzie‚Äù. Politycy zapewniajƒÖ, ≈ºe ‚Äûnajgorsze za nami‚Äù, ale podwy≈ºszone c≈Ça (Smoot‚ÄìHawley) uderzajƒÖ w handel, a firmy tnƒÖ inwestycje i etaty. Kr√≥tkotrwa≈Ça hossa ≈Çatwo wciƒÖga nieostro≈ºnych z powrotem na rynek.',
              choices:[{text:'Blue-chipy z dywidendƒÖ',effect:'buy_dividends'},{text:'Kopalnie z≈Çota',effect:'buy_gold_miners'},{text:'Obligacje rzƒÖdowe',effect:'buy_bonds'},{text:'Za≈Ç√≥≈º firmƒô',effect:'start_business'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2a/Construction_New_Deal.jpg' },
            { month:'Wrzesie≈Ñ 1931', indexValue:130, title:'Depresja siƒô pog≈Çƒôbia', description:'Upad≈Ço≈õci bank√≥w i firm mno≈ºƒÖ siƒô, bezrobocie ro≈õnie. Ludzie wycofujƒÖ got√≥wkƒô, co dodatkowo os≈Çabia banki ‚Äî spirala siƒô zacie≈õnia. Inwestorzy szukajƒÖ bezpiecze≈Ñstwa: sp√≥≈Çek, kt√≥rych produkty kupuje siƒô ‚Äûzawsze‚Äù (≈ºywno≈õƒá, media, u≈ºyteczno≈õƒá publiczna) oraz czystej got√≥wki, kt√≥ra daje mo≈ºliwo≈õƒá ruchu, gdy pojawi siƒô okazja.',
              choices:[{text:'Nieruchomo≈õci w kryzysie',effect:'buy_real_estate'},{text:'Firmy spo≈ºywcze',effect:'buy_staples'},{text:'Gromad≈∫ got√≥wkƒô',effect:'hoard_cash'},{text:'Wiƒôcej z≈Çota',effect:'buy_more_gold'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/9c/Breadline.jpg' },
            { month:'Lipiec 1932', indexValue:41, title:'Samo dno', description:'Indeks traci oko≈Ço 90% od szczytu. Wyceny sƒÖ najni≈ºsze w historii, ale nastroje fatalne. ‚ÄûKapitulacja‚Äù oznacza, ≈ºe wiƒôkszo≈õƒá sprzedaje ze strachu. Kupowanie na dnie bywa zyskowne ‚Äî tylko ≈ºe nikt nie wie, ≈ºe to dno, dop√≥ki nie minie. Selekcja jako≈õci ma kluczowe znaczenie.',
              choices:[{text:'All-in w akcje',effect:'buy_bottom'},{text:'Silne sp√≥≈Çki (IBM)',effect:'buy_quality'},{text:'Akcje alkoholowe',effect:'buy_alcohol'},{text:'Zosta≈Ñ przy got√≥wce',effect:'stay_safe'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/14/Newspaper_boy_1930s.jpg' },
            { month:'Marzec 1933', indexValue:63, title:'Nowy ≈Åad', description:'Prezydent og≈Çasza ‚Äûbank holiday‚Äù ‚Äî banki na kilka dni sƒÖ zamkniƒôte, system zostaje uporzƒÖdkowany, wchodzi ubezpieczenie depozyt√≥w. Programy rob√≥t publicznych i dewaluacja dolara wspierajƒÖ gospodarkƒô i ceny z≈Çota. To pierwszy wiarygodny sygna≈Ç, ≈ºe dno jest ju≈º za nami.',
              choices:[{text:'Infrastruktura',effect:'buy_infrastructure'},{text:'Sprzedaj z≈Çoto (ryzyko regulacji)',effect:'sell_gold'},{text:'Rolnictwo',effect:'buy_agriculture'},{text:'Koleje',effect:'buy_railroads'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/1a/CCC-workers.jpg' }
          ],
          stockPrices:{ 'General Electric':[396,168,134,85,34,58], 'AT&T':[304,197,178,144,110,136], 'US Steel':[262,150,88,54,22,43], 'Z≈Çoto':[20.67,20.67,20.67,20.67,35.00,35.00], 'Coca-Cola':[78,45,56,62,48,67], 'IBM':[211,98,67,45,78,124] }
        },

        '1970s': {
          era:'Lata 1970', name:'Kryzys Naftowy i Stagflacja', desc:'Embargo OPEC, inflacja i recesje. Jak chroniƒá realnƒÖ warto≈õƒá?',
          title:'Inwestor Kryzysu Naftowego',
          subtitle:'Lata 70. to szko≈Ça przetrwania: ceny ropy rosnƒÖ jak szalone, inflacja wysysa si≈Çƒô nabywczƒÖ, a gospodarka zwalnia. Zobaczysz, kto korzysta na drogim paliwie, a kto cierpi ‚Äî i jak my≈õleƒá o ochronie oszczƒôdno≈õci.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'Pa≈∫dziernik 1973', indexValue:108, title:'Wojna Yom Kippur', description:'OPEC ogranicza wydobycie i eksport. Cena ropy skacze wielokrotnie; na stacjach ustawiajƒÖ siƒô kolejki, a koszt transportu i produkcji ro≈õnie niemal wszƒôdzie. To szok poda≈ºowy: mniej towaru ‚Üí wy≈ºsze ceny. Firmy paliwowe i w≈Ça≈õciciele surowc√≥w zarabiajƒÖ, a linie lotnicze i logistyka dostajƒÖ cios.',
              choices:[{text:'Kup sp√≥≈Çki naftowe',effect:'buy_oil'},{text:'Short na transport',effect:'short_transport'},{text:'Energia alternatywna',effect:'buy_alt_energy'},{text:'Z≈Çoto i towary',effect:'buy_commodities_70s'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/0/0a/Gas_station_line2.jpg' },
            { month:'Marzec 1974', indexValue:95, title:'Kryzys siƒô pog≈Çƒôbia', description:'RzƒÖdy pr√≥bujƒÖ zamra≈ºaƒá ceny, co ko≈Ñczy siƒô niedoborami. Inflacja ro≈õnie, a gospodarka hamuje ‚Äî to ‚Äûstagflacja‚Äù. Dla inwestora oznacza to, ≈ºe got√≥wka traci si≈Çƒô nabywczƒÖ, a zwyk≈Çe obligacje te≈º nie ratujƒÖ. ZyskujƒÖ biznesy z mocnym ‚Äûpricing power‚Äù i infrastruktura energetyczna.',
              choices:[{text:'Infrastruktura energetyczna',effect:'buy_energy_infrastructure'},{text:'Towary podstawowe (staples)',effect:'buy_staples_70s'},{text:'Nieruchomo≈õci',effect:'buy_real_estate_70s'},{text:'Got√≥wka',effect:'hold_cash_70s'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/1/17/Oil_barrel.jpg' },
            { month:'Sierpie≈Ñ 1974', indexValue:72, title:'Rezygnacja Nixona', description:'Kryzys polityczny zwiƒôksza niepewno≈õƒá, a wysokie stopy procentowe obni≈ºajƒÖ wyceny sp√≥≈Çek wzrostowych. Inwestorzy szukajƒÖ przystani w dywidendach i metalach szlachetnych. Kr√≥tka sprzeda≈º sektor√≥w zale≈ºnych od taniego finansowania mo≈ºe dzia≈Çaƒá, ale wymaga dyscypliny.',
              choices:[{text:'Dywidendowe defensywy',effect:'buy_dividends_70s'},{text:'Metale szlachetne',effect:'buy_precious_metals'},{text:'Short growth',effect:'short_growth'},{text:'Rynki miƒôdzynarodowe',effect:'buy_international'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/0/0d/Nixon_Resigns.jpg' },
            { month:'Stycze≈Ñ 1975', indexValue:68, title:'Mocna recesja', description:'Bezrobocie siƒôga szczyt√≥w. Bank centralny zaczyna luzowaƒá politykƒô, ale inflacja nadal wysoka. ‚ÄûJako≈õƒá po przecenie‚Äù czƒôsto wygrywa w kolejnych latach. RealnƒÖ warto≈õƒá pomagajƒÖ chroniƒá aktywa rosnƒÖce z inflacjƒÖ (czƒô≈õƒá towar√≥w, nieruchomo≈õci) i obligacje indeksowane inflacjƒÖ.',
              choices:[{text:'Jako≈õƒá po przecenie',effect:'buy_quality_70s'},{text:'Tech efektywno≈õciowy',effect:'buy_efficiency_tech'},{text:'Rolnictwo',effect:'buy_agriculture_70s'},{text:'Inflation-linked',effect:'buy_tips'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2e/Unemployment_line_1970s.jpg' },
            { month:'Lipiec 1976', indexValue:104, title:'Dwustulecie', description:'Gospodarka ≈Çapie oddech. Firmy inwestujƒÖ w oszczƒôdno≈õƒá energii i automatyzacjƒô; do przemys≈Çu wchodzƒÖ mikroprocesory. Innowacje potrafiƒÖ poprawiƒá produktywno≈õƒá nawet w trudnych czasach kosztowych.',
              choices:[{text:'Wczesny tech',effect:'buy_tech_70s'},{text:'Oszczƒôdzanie energii',effect:'buy_conservation'},{text:'Dobra konsumpcyjne',effect:'buy_consumer_disc'},{text:'Zosta≈Ñ w towarach',effect:'stay_commodities'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/53/Microprocessor.jpg' },
            { month:'Grudzie≈Ñ 1978', indexValue:96, title:'Drugi szok naftowy', description:'Napiƒôcia na Bliskim Wschodzie ponownie ograniczajƒÖ poda≈º ropy. Inflacja rozkrƒôca siƒô, a rynki zaczynajƒÖ dyskontowaƒá ostrzejszƒÖ politykƒô pieniƒô≈ºnƒÖ w kolejnych latach. Premiowane sƒÖ realne aktywa i sp√≥≈Çki surowcowe; sektory wra≈ºliwe na stopy dostajƒÖ po kieszeni.',
              choices:[{text:'Ponownie: sp√≥≈Çki naftowe',effect:'buy_oil_again'},{text:'Mocniej w alternatywƒô',effect:'buy_alt_energy_late'},{text:'Aktywa antyinflacyjne',effect:'buy_inflation_assets'},{text:'Short sektory wra≈ºliwe na stopy',effect:'short_rates'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/9a/Oil_platform.jpg' }
          ],
          stockPrices:{ 'Exxon Mobil':[52,71,84,78,89,96], 'Texaco':[28,42,38,35,47,52], 'Ford':[65,41,38,33,42,39], 'Z≈Çoto':[97,154,161,140,125,208], 'IBM':[341,246,238,264,287,354], "McDonald's":[77,52,49,58,71,86] }
        },

        '1990s': {
          era:'Lata 1990', name:'Azja, LTCM i euforia', desc:'Od recesji 1990‚Äì91 do bƒÖbla internetowego.',
          title:'Inwestor Lata 90.',
          subtitle:'Od ‚Äûflight to quality‚Äù po ‚Äûdon‚Äôt fight the Fed‚Äù: jak rynki reagujƒÖ na kryzysy i euforie.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'Listopad 1990', indexValue:324, title:'Recesja po Gulf War buildup', description:'Firmy tnƒÖ koszty, kredyt jest drogi, nastroje konsument√≥w s≈ÇabnƒÖ. Upad≈Ço≈õci instytucji S&L oraz napiƒôcia wok√≥≈Ç Zatoki Perskiej zwiƒôkszajƒÖ niepewno≈õƒá. W takiej fazie defensywy i obligacje skarbowe zwykle trzymajƒÖ siƒô lepiej ni≈º ryzykowne ‚Äûwzrost√≥wki‚Äù.',
              choices:[{text:'Kup defensywy i dywidendy',effect:'buy_def_90'},{text:'Czekaj z got√≥wkƒÖ',effect:'hold_cash_90'},{text:'Kup obligacje skarbowe',effect:'buy_bonds_90'},{text:'Agresywnie tech ‚Äì PC boom',effect:'buy_pc_90'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/3/3d/Personal_computers_1990s.jpg' },
            { month:'Lipiec 1995', indexValue:560, title:'Soft landing', description:'Po podwy≈ºkach st√≥p w 1994 r. gospodarka ‚Äûsiada‚Äù miƒôkko: inflacja pod kontrolƒÖ, a firmy dziƒôki komputerom, internetowi i globalizacji poprawiajƒÖ produktywno≈õƒá. Tanie fundusze indeksowe zdobywajƒÖ popularno≈õƒá ‚Äî wielu inwestor√≥w zamiast wybieraƒá pojedyncze sp√≥≈Çki, kupuje ca≈Çy rynek.',
              choices:[{text:'Szeroki indeks (passive)',effect:'buy_index_95'},{text:'Small-caps value',effect:'buy_scv_95'},{text:'Sp√≥≈Çki telekom',effect:'buy_telco_95'},{text:'Utrzymaj defensywy',effect:'stay_def_95'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/6/6d/NYSE_trading_floor.jpg' },
            { month:'Pa≈∫dziernik 1997', indexValue:950, title:'Kryzys azjatycki', description:'Kilka kraj√≥w broni sta≈Çych kurs√≥w walut, a≈º system pƒôka. Firmy zad≈Çu≈ºone w dolarze tracƒÖ finansowanie, kapita≈Ç ucieka do bezpiecznych aktyw√≥w. USA te≈º dostajƒÖ rykoszetem, ale silna gospodarka sprawia, ≈ºe spadki szybko sƒÖ odrabiane ‚Äî klasyczny ‚Äûflight to quality‚Äù.',
              choices:[{text:'Kup spadki w USA',effect:'buy_dip_97'},{text:'Uciekaj w obligacje',effect:'bonds_97'},{text:'Short EM',effect:'short_em_97'},{text:'Kup z≈Çoto',effect:'gold_97'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/7/7b/Bangkok_skyline_1997.jpg' },
            { month:'Wrzesie≈Ñ 1998', indexValue:957, title:'LTCM pƒôka', description:'S≈Çynny fundusz hedgingowy traci p≈Çynno≈õƒá na wielkich, lewarowanych pozycjach. Fed koordynuje porozumienie bank√≥w, by uniknƒÖƒá chaosu. Rynek dostaje lekcjƒô o ryzyku d≈∫wigni i korelacji ‚Äî a potem zaczyna siƒô szybki rajd.',
              choices:[{text:'Wejd≈∫ po interwencji Fed',effect:'buy_after_fed_98'},{text:'Pozosta≈Ñ w got√≥wce',effect:'hold_98'},{text:'Short lewar/finanse',effect:'short_fin_98'},{text:'Kup tech momentum',effect:'buy_momo_98'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/4/49/Alan_Greenspan.jpg' },
            { month:'Grudzie≈Ñ 1999', indexValue:1469, title:'Euforia milenijna', description:'Internet ‚Äûzmieni wszystko‚Äù ‚Äî tak brzmi narracja. Wyceny wielu m≈Çodych sp√≥≈Çek opierajƒÖ siƒô bardziej na obietnicach ni≈º na zyskach. FOMO pcha ceny jeszcze wy≈ºej. Pamiƒôtaj: na d≈Çu≈ºszƒÖ metƒô zyski i przep≈Çywy muszƒÖ dogoniƒá opowie≈õƒá.',
              choices:[{text:'All-in w dot-comy',effect:'allin_dotcom_99'},{text:'Rotacja do value',effect:'rot_value_99'},{text:'Rebalans 60/40',effect:'rebal_99'},{text:'Short najdro≈ºsze sp√≥≈Çki',effect:'short_hyper_99'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2b/Nasdaq_screen_times_square.jpg' }
          ],
          stockPrices:{ 'Microsoft':[0.9,2.4,4.6,5.2,8.9], 'Cisco':[0.4,1.6,3.1,4.2,7.7], 'General Electric':[1.2,1.7,2.2,2.4,2.8], 'Treasuries (10Y)*':[100,103,106,104,98], 'Z≈Çoto':[380,385,325,290,290], '* ceny ideowe':['‚Äî','‚Äî','‚Äî','‚Äî','‚Äî'] }
        },

        'DotCom': {
          era:'2000‚Äì2002', name:'Ba≈Ñka Dot-com', desc:'Euforia internetowa i bolesne otrze≈∫wienie.',
          title:'Inwestor ery dot-com',
          subtitle:'Zobacz, jak narracja ‚Äûnowej ekonomii‚Äù zderzy≈Ça siƒô z brakiem zysk√≥w ‚Äî i kto przetrwa≈Ç.',
          indexLabel:'NASDAQ',
          scenarios:[
            { month:'Marzec 2000', indexValue:5048, title:'Szczyt euforii', description:'IPO pojawiajƒÖ siƒô co tydzie≈Ñ, a wyceny oderwa≈Çy siƒô od rzeczywisto≈õci: wiele sp√≥≈Çek nie ma jeszcze zysk√≥w ani przep≈Çyw√≥w pieniƒô≈ºnych. Inwestorzy p≈ÇacƒÖ za obietnice ‚Äûkiedy≈õ‚Äù. Najwiƒôksze ryzyko? Zmiana nastroju i wysychanie finansowania.',
              choices:[{text:'Kup ka≈ºdy debiut',effect:'buy_ipos_00'},{text:'Rotacja do quality tech',effect:'rot_quality_00'},{text:'Powa≈ºny rebalans do value',effect:'rot_value_00'},{text:'Short ekstremalne wyceny',effect:'short_extreme_00'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/2/2b/Nasdaq_screen_times_square.jpg' },
            { month:'Listopad 2000', indexValue:3000, title:'Rysa na narracji', description:'Przychody nie rosnƒÖ tak szybko, a inwestorzy przestajƒÖ wierzyƒá w ‚Äûzyski kiedy≈õ‚Äù. Kapita≈Ç ucieka ze sp√≥≈Çek bez got√≥wki, spread miƒôdzy quality-tech a resztƒÖ siƒô otwiera.',
              choices:[{text:'Trzymaj i ‚Äûprzeczekaj‚Äù',effect:'hold_bag_00'},{text:'Przesu≈Ñ do got√≥wki',effect:'move_cash_00'},{text:'Kup tylko profitable tech',effect:'buy_prof_00'},{text:'Hedge opcjami/short ETF',effect:'hedge_00'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/9/98/Internet_bubble_chart.png' },
            { month:'Wrzesie≈Ñ 2001', indexValue:1423, title:'Szok 9/11', description:'Zamachy zwiƒôkszajƒÖ niepewno≈õƒá; popyt na podr√≥≈ºe i reklamy spada. Polityka pieniƒô≈ºna ≈Çagodzi warunki, ale spekulacyjne nazwy tracƒÖ blask.',
              choices:[{text:'Kup obronƒô i bezpiecze≈Ñstwo',effect:'buy_defense_01'},{text:'Short travel/lotnictwo',effect:'short_travel_01'},{text:'Pozosta≈Ñ przy got√≥wce',effect:'hold_cash_01'},{text:'Dowa≈º tech quality',effect:'buy_quality_01'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5c/NYC_9-11_WTC.jpg' },
            { month:'Pa≈∫dziernik 2002', indexValue:1114, title:'P√≥≈∫ne dno', description:'Wiele dot-com√≥w znika z gie≈Çdy, zostajƒÖ liderzy z prawdziwymi przep≈Çywami i przewagami konkurencyjnymi. To moment, w kt√≥rym selekcja jako≈õci zn√≥w wygrywa.',
              choices:[{text:'Kup lider√≥w ‚Äì MSFT, INTC',effect:'buy_leaders_02'},{text:'Dowa≈º value/cashflow',effect:'buy_value_02'},{text:'Zosta≈Ñ w obligacjach',effect:'stay_bonds_02'},{text:'Spekuluj penny-stocks',effect:'penny_02'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/6/6b/NASDAQ_MarketSite.jpg' }
          ],
          stockPrices:{ 'Cisco':[77,50,15,13], 'Amazon':[75,36,6,15], 'Pets.com':[14,4,0,0], 'Microsoft':[58,34,24,26], 'US 10Y (cena)*':[98,101,108,106], '* gwiazdka':['‚Äî','‚Äî','‚Äî','‚Äî'] }
        },

        'BlackMonday': {
          era:'1987', name:'Black Monday', desc:'Najwiƒôkszy jednodniowy krach w historii. Dow Jones -22.6% w jeden dzie≈Ñ!',
          title:'Inwestor Black Monday',
          subtitle:'19 pa≈∫dziernika 1987 ‚Äì najczarniejszy poniedzia≈Çek w historii Wall Street. Portfolio insurance i panika wywo≈Ça≈Çy lawinƒô.',
          indexLabel:'Dow Jones',
          scenarios:[
            { month:'Sierpie≈Ñ 1987', indexValue:2722, title:'Szczyt hossy', description:'Rynek byka trwa od 5 lat. Dow Jones zyska≈Ç ponad 40% tylko w tym roku. Popularne stajƒÖ siƒô ‚Äûportfolio insurance" ‚Äì automatyczne systemy, kt√≥re sprzedajƒÖ, gdy rynek spada. Analitycy ostrzegajƒÖ przed przegrzanƒÖ gospodarkƒÖ i rosnƒÖcymi stopami.',
              choices:[{text:'Zosta≈Ñ w indeksie ‚Äì hossa trwa',effect:'stay_bull_87'},{text:'Zabezpiecz opcjami put',effect:'buy_puts_87'},{text:'Rotacja do obligacji',effect:'rotate_bonds_87'},{text:'Short przez futures',effect:'short_fut_87'}]},
            { month:'16 Pa≈∫dziernik 1987', indexValue:2246, title:'PiƒÖtek przed krachem', description:'Rynek spada mocno w piƒÖtek. Portfolio insurance aktywuje siƒô ‚Äì automatyczne zlecenia sprzeda≈ºy zalewajƒÖ rynek. Przez weekend media rozgrzewajƒÖ atmosferƒô. Strach narasta.',
              choices:[{text:'Sprzedaj wszystko przed weekendem',effect:'sell_friday_87'},{text:'Kup spadki ‚Äì przesada',effect:'buy_dip_87'},{text:'Zostaw portfel ‚Äì to korekta',effect:'hold_87'},{text:'Hedge dodatkowymi puts',effect:'more_puts_87'}]},
            { month:'19 Pa≈∫dziernik 1987', indexValue:1738, title:'BLACK MONDAY', description:'Dow Jones spada o 22.6% w JEDEN dzie≈Ñ! Portfolio insurance wywo≈Çuje spiralƒô sprzeda≈ºy. Systemy komputerowe automatycznie rzucajƒÖ akcje, co pog≈Çƒôbia panikƒô. Brokerzy nie nadƒÖ≈ºajƒÖ z realizacjƒÖ zlece≈Ñ. To chaos.',
              choices:[{text:'PANIKA ‚Äì sprzedaj wszystko',effect:'panic_sell_87'},{text:'Kup dno ‚Äì historyczna okazja',effect:'buy_crash_87'},{text:'Czekaj na stabilizacjƒô',effect:'wait_stable_87'},{text:'Short dalej ‚Äì bƒôdzie gorzej',effect:'short_more_87'}]},
            { month:'Grudzie≈Ñ 1987', indexValue:1938, title:'Odbicie po szoku', description:'Fed obni≈ºa stopy, zapewnia p≈Çynno≈õƒá. Rynek odbija o 11% od do≈Çka. Gospodarka fundamentalnie mocna ‚Äì krach by≈Ç bardziej techniczny ni≈º fundamentalny. Odwaga zosta≈Ça nagrodzona.',
              choices:[{text:'Kup quality blue chips',effect:'buy_quality_87'},{text:'Zwiƒôksz ekspozycjƒô na tech',effect:'buy_tech_87'},{text:'Pozosta≈Ñ w defensywach',effect:'stay_def_87'},{text:'Zachowaj got√≥wkƒô',effect:'keep_cash_87'}]}
          ],
          stockPrices:{ 'IBM':[157,132,103,120], 'Microsoft':[2.1,1.8,1.4,1.6], 'GE':[52,43,33,39], 'Z≈Çoto':[460,465,480,485], 'Bonds':[100,102,108,106] }
        },

        'GFC2008': {
          era:'2008‚Äì2009', name:'Wielki Kryzys Finansowy', desc:'Ba≈Ñka kredytowa, Lehman, QE i dno 2009.',
          title:'Inwestor 2008',
          subtitle:'Od ‚Äûto lokalne‚Äù do globalnej paniki: jak dzia≈Ça≈Ça d≈∫wignia, p≈Çynno≈õƒá i interwencje.',
          indexLabel:'S&P 500',
          scenarios:[
            { month:'Sierpie≈Ñ 2007', indexValue:1455, title:'Rysa na rynku kredytu', description:'Rynek kredyt√≥w hipotecznych subprime zaczyna pƒôkaƒá. Struktury sekurytyzacyjne maskowa≈Çy ryzyko, a wyceny MBS stajƒÖ siƒô niepewne. To wstƒôp do problem√≥w p≈Çynno≈õciowych.',
              choices:[{text:'Short homebuilders/MBS',effect:'short_mbs_07'},{text:'Przesu≈Ñ do quality',effect:'move_quality_07'},{text:'Ignoruj ‚Äì ‚Äûto lokalne‚Äù',effect:'ignore_07'},{text:'Kup z≈Çoto',effect:'gold_07'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/8/8b/Subprime_Mortgage_Crisis_2007.png' },
            { month:'Marzec 2008', indexValue:1276, title:'Bear Stearns przejƒôty', description:'Fed pomaga sprzedaƒá Bear Stearns, aby zatrzymaƒá panikƒô. Rynek ≈Çapie kr√≥tkie oddechy, ale problemy strukturalne nie znikajƒÖ.',
              choices:[{text:'Kup banki ‚Äì ‚Äûkrew na ulicach‚Äù',effect:'buy_banks_08'},{text:'Hedge vega/short finanse',effect:'short_fin_08'},{text:'Uciekaj do got√≥wki',effect:'cash_08'},{text:'Kup sp√≥≈Çki defensywne',effect:'def_08'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/4/46/Bear_Stearns_Headquarters.jpg' },
            { month:'Wrzesie≈Ñ 2008', indexValue:1204, title:'Lehman upada', description:'Zamro≈ºenie rynku finansowania hurtowego i eksplozja ryzyka kontrahenta powodujƒÖ gwa≈ÇtownƒÖ wyprzeda≈º. Fundusze rynku pieniƒô≈ºnego ‚Äû≈ÇamiƒÖ dolara‚Äù. Schronienia: z≈Çoto i obligacje.',
              choices:[{text:'Kup indeks ‚Äì ultra ryzyko',effect:'buy_index_09'},{text:'Kup z≈Çoto/obligacje',effect:'safe_haven_08'},{text:'Short cykliczne',effect:'short_cyc_08'},{text:'Pozosta≈Ñ w cash',effect:'stay_cash_08'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Lehman_Brothers_Times_Square_by_David_Shankbone.jpg' },
            { month:'Marzec 2009', indexValue:676, title:'Dno i QE1', description:'Bank centralny uruchamia QE, a firmy z mocnymi bilansami wracajƒÖ do ≈Çask. To historyczny punkt zwrotny: rynek zaczyna odbijaƒá od dna.',
              choices:[{text:'All-in quality + indeks',effect:'allin_09'},{text:'Kup value/finanse',effect:'buy_value_09'},{text:'Zosta≈Ñ w obligacjach',effect:'stay_bonds_09'},{text:'Czekaj ‚Äì ‚Äûza wcze≈õnie‚Äù',effect:'wait_09'}],
              image:'https://upload.wikimedia.org/wikipedia/commons/5/5c/Federal_Reserve_Building.jpg' }
          ],
          stockPrices:{ 'SPY (ETF)':[145,128,120,70], 'Gold':[670,920,890,920], 'JPM':[47,40,25,25], 'Caterpillar':[80,72,35,28], 'US 10Y (cena)*':[99,104,109,108], '* gwiazdka':['‚Äî','‚Äî','‚Äî','‚Äî'] }
        }
      };

      // --------- MENU ---------
      function buildMenu(){
        console.log('üìã Building menu...');
        const keys = Object.keys(chapters);
        console.log('üìö Chapters:', keys);
        const html = keys.map(key => {
          const c = chapters[key];
          return `<article class="chapter-card" data-key="${key}" tabindex="0" role="button" aria-label="${c.era}: ${c.name}">
            <div class="chapter-era">${c.era}</div>
            <div class="chapter-name">${c.name}</div>
            <div class="chapter-description">${c.desc}</div>
          </article>`;
        }).join('');
        dom.chapterSelection.innerHTML = html || '<p>Brak rozdzia≈Ç√≥w.</p>';

        const cards = dom.chapterSelection.querySelectorAll('.chapter-card');
        console.log('üÉè Found cards:', cards.length);

        cards.forEach(card => {
          card.addEventListener('click', () => {
            console.log('üéØ Card clicked:', card.dataset.key);
            startChapter(card.dataset.key);
          });
          card.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              console.log('‚å®Ô∏è Enter pressed on:', card.dataset.key);
              startChapter(card.dataset.key);
            }
          });
        });
        console.log('‚úÖ Menu built with', cards.length, 'cards');
      }

      // --------- GAME FLOW ---------
      function startChapter(key){
        console.log('üöÄ Starting chapter:', key);
        currentChapterKey = key;
        capital = 1000;
        currentScenario = 0;
        decisions = 0;
        capitalHistory = [1000]; // Reset and track starting capital
        achievements = []; // Reset achievements
        const ch = chapters[key];

        if (!ch) {
          console.error('‚ùå Chapter not found:', key);
          alert('B≈ÇƒÖd: Nie znaleziono rozdzia≈Çu ' + key);
          return;
        }

        console.log('üìñ Chapter:', ch.title);

        dom.chapterTitle.textContent = ch.title;
        dom.chapterSubtitle.textContent = ch.subtitle;
        dom.indexLabel.textContent = ch.indexLabel;
        dom.decisions.textContent = decisions;

        // Hide all menus
        console.log('üôà Hiding menus...');
        dom.mainMenu.classList.add('hidden');
        hideWelcomeScreen();
        hideModal();

        // Show game
        console.log('üëÅÔ∏è Showing game area...');
        dom.gameArea.classList.remove('hidden');
        renderScenario();
        updateProgress();
        console.log('‚úÖ Chapter started!');
      }

      function showMainMenu(){
        dom.gameArea.classList.add('hidden');
        showWelcomeScreen(); // Show welcome screen instead of old menu
      }

      function updateProgress(){ const total = chapters[currentChapterKey].scenarios.length; const pct = Math.min(100, Math.round(((currentScenario)/total)*100)); dom.progressBar.style.width = pct + '%'; }

      function formatPrice(v){ if (typeof v === 'string') return v; if (v >= 10) return '$' + v.toLocaleString(); return '$' + Number(v).toFixed(2); }

      function renderGraphic(chKey){
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        const accent2 = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
        const base = `<svg width="100%" height="90" viewBox="0 0 400 90" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="${accent}"/><stop offset="100%" stop-color="${accent2}"/></linearGradient></defs><rect x="0" y="0" width="400" height="90" fill="none" stroke="rgba(255,255,255,0.06)"/>`;
        const tail = `</svg>`;
        const bull = '<path d="M5,70 C60,40 120,60 170,35 C220,20 280,50 330,30 C360,20 380,25 395,20" fill="none" stroke="url(#g)" stroke-width="3" />';
        const bear = '<path d="M5,20 C60,40 120,25 170,45 C220,60 280,30 330,50 C360,60 380,55 395,62" fill="none" stroke="url(#g)" stroke-width="3" />';
        const oil = '<path d="M60,80 L80,20 L100,80 Z M140,80 L160,25 L180,80 Z M220,80 L240,22 L260,80 Z" fill="url(#g)" opacity="0.8"/>';
        const chip = '<rect x="150" y="20" width="100" height="50" rx="6" stroke="url(#g)" fill="none" stroke-width="3"/><g opacity="0.7"><rect x="145" y="12" width="6" height="16"/><rect x="249" y="12" width="6" height="16"/><rect x="145" y="62" width="6" height="16"/><rect x="249" y="62" width="6" height="16"/></g>';
        const bank = '<rect x="40" y="30" width="320" height="40" rx="4" fill="none" stroke="url(#g)" stroke-width="3"/><path d="M40,30 L200,10 L360,30" stroke="url(#g)" stroke-width="3" fill="none"/>';
        let body = bull; if (chKey==='1930s') body = bear; else if (chKey==='1970s') body = oil; else if (chKey==='1990s') body = chip; else if (chKey==='DotCom') body = bull; else if (chKey==='GFC2008') body = bank;
        return base + body + tail;
      }

      function renderScenario(){
        const ch = chapters[currentChapterKey];
        const s = ch.scenarios[currentScenario];
        dom.capital.textContent = `$${capital.toLocaleString()}`;
        dom.month.textContent = s.month;
        dom.indexValue.textContent = s.indexValue;
        dom.decisions.textContent = decisions;

        const hintText = (hints[currentChapterKey] && hints[currentChapterKey][currentScenario]) || '';

        dom.gameContent.innerHTML = `
          <section class="panel">
            <h3 class="panel-title">${s.title}</h3>
            <div class="scenario-graphic">${renderGraphic(currentChapterKey)}</div>
            <p class="scenario-text">${s.description}</p>
            <div class="choices">
              ${s.choices.map((c,i)=>`<button class="choice-btn" data-idx="${i}">${c.text}</button>`).join('')}
            </div>
            <button class="hint-btn" id="hintBtn" aria-expanded="false" aria-controls="hintBox">üí° Wskaz√≥wka</button>
            <div id="hintBox" class="hint-box" aria-hidden="true">${hintText}</div>
          </section>
          <aside class="panel" aria-label="Ceny na rynku">
            <h3 class="panel-title">Ceny na rynku</h3>
            <div class="stock-list">
              ${Object.entries(ch.stockPrices).map(([name, arr]) => `
                <div class="stock-item"><span class="stock-name">${name}</span><span class="stock-price">${formatPrice(arr[currentScenario])}</span></div>
              `).join('')}
            </div>
          </aside>`;

        dom.gameContent.querySelectorAll('.choice-btn').forEach(btn => btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-idx'));
          makeChoice(idx);
        }));

        const hintBtn = document.getElementById('hintBtn');
        const hintBox = document.getElementById('hintBox');
        if (hintBtn && hintBox) {
          hintBtn.addEventListener('click', () => {
            const expanded = hintBtn.getAttribute('aria-expanded') === 'true';
            hintBtn.setAttribute('aria-expanded', String(!expanded));
            hintBox.setAttribute('aria-hidden', String(expanded));
          });
        }
        updateProgress();
      }

      function rng(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

      function calculateResult(effect){
        const R=(min,max)=>rng(min,max); let moneyChange=0, message='', type='neutral';
        const outcomes={
          // 1930s
          buy_stocks:[-600,'Kupi≈Çe≈õ tu≈º przed krachem!','loss'], sell_all:[100,'UniknƒÖ≈Çe≈õ krachu ‚Äì brawo.','profit'], buy_gold:[50,'Z≈Çoto utrzyma≈Ço warto≈õƒá.','profit'], short_market:[400,'Doskona≈Çy timing na short!','profit'],
          buy_dip:[-R(250,450),'Spadki jeszcze bola≈Çy.','loss'], hold_cash:[R(10,40),'Bezpiecznie, ale nudno.','neutral'], buy_utilities:[R(-40,60),'U≈ºyteczno≈õci trzymajƒÖ siƒô lepiej.','neutral'], buy_commodities:[R(-30,80),'Towary mieszane, zale≈ºne od popytu.','neutral'], buy_dividends:[R(-40,90),'Dywidendy amortyzujƒÖ spadki.','neutral'], buy_gold_miners:[R(-50,120),'G√≥rnicy z≈Çota zmienni, ale dajƒÖ alfƒô.','neutral'], buy_bonds:[R(20,80),'Obligacje rzƒÖdowe stabilizujƒÖ.','profit'], start_business:[R(-120,200),'Ryzyko w recesji ogromne.','neutral'], buy_real_estate:[R(-180,120),'RE w depresji bardzo ryzykowne.','loss'], buy_staples:[R(10,90),'Staples bardziej odporne.','profit'], hoard_cash:[R(0,40),'Got√≥wka kr√≥lem w kryzysie.','neutral'], buy_more_gold:[R(20,90),'Z≈Çoto trzyma warto≈õƒá.','profit'], buy_bottom:[R(160,420),'Kupno dna ‚Äì legenda.','profit'], buy_quality:[R(80,240),'Jako≈õƒá wychodzi z kryzysu mocniej.','profit'], buy_alcohol:[R(20,120),'‚ÄûSin stocks‚Äù bywajƒÖ defensywne.','profit'], stay_safe:[R(-10,30),'Bezpiecznie, ale ominiesz odbicie.','neutral'], buy_infrastructure:[R(40,160),'New Deal pompowa≈Ç inwestycje.','profit'], sell_gold:[R(-60,40),'Niepewno≈õƒá co do regulacji.','neutral'], buy_agriculture:[R(20,90),'Wsparcie program√≥w rolnych.','profit'], buy_railroads:[R(-20,80),'Koleje cykliczne, ale skorzystajƒÖ na inwestycjach.','neutral'],
          // 1970s
          buy_oil:[R(250,380),'Energetyka eksplodowa≈Ça w g√≥rƒô.','profit'], short_transport:[R(180,340),'Transport oberwa≈Ç ‚Äì zysk.','profit'], buy_alt_energy:[R(-50,180),'Wczesna faza ‚Äî mieszane.','neutral'], buy_commodities_70s:[R(40,140),'Towary hedgujƒÖ inflacjƒô.','profit'], buy_energy_infrastructure:[R(40,150),'RurociƒÖgi/rafinerie zyskujƒÖ.','profit'], buy_staples_70s:[R(20,100),'Podstawowe dobra trzymajƒÖ popyt.','profit'], buy_real_estate_70s:[R(20,120),'Nieruchomo≈õci jako tarcza.','profit'], hold_cash_70s:[R(-20,20),'Inflacja zjada cash.','loss'], buy_dividends_70s:[R(10,80),'Dywidendy ≈ÇagodzƒÖ b√≥l.','neutral'], buy_precious_metals:[R(60,180),'Z≈Çoto/srebro korzystajƒÖ.','profit'], short_growth:[R(60,160),'Wzrost√≥wki karcone stopami.','profit'], buy_international:[R(-30,120),'Dywersyfikacja bywa pomocna.','neutral'], buy_quality_70s:[R(40,160),'Jako≈õƒá po przecenie.','profit'], buy_efficiency_tech:[R(20,140),'Efektywno≈õƒá kosztowa mile widziana.','profit'], buy_agriculture_70s:[R(20,120),'Rolnictwo korzysta z cen towar√≥w.','profit'], buy_tips:[R(20,90),'Inflation-linked chroniƒÖ realny zwrot.','profit'], buy_tech_70s:[R(-20,120),'Wczesny tech zmienny.','neutral'], buy_conservation:[R(10,120),'Oszczƒôdno≈õƒá energii trendem.','profit'], buy_consumer_disc:[R(-40,80),'Dyskrecyjne wra≈ºliwe na realne dochody.','neutral'], stay_commodities:[R(-20,80),'Zale≈ºne od cyklu; czƒô≈õciowo dzia≈Ça.','neutral'], buy_oil_again:[R(80,200),'Drugi szok naftowy.','profit'], buy_alt_energy_late:[R(-20,140),'Alternatywa ro≈õnie, ale niestabilna.','neutral'], buy_inflation_assets:[R(40,160),'Aktywa antyinflacyjne w cenie.','profit'], short_rates:[R(40,140),'Wra≈ºliwe sektory cierpiƒÖ.','profit'],
          // 1990s
          buy_def_90:[R(40,120),'Defensywy ochroni≈Çy portfel.','profit'], hold_cash_90:[R(-20,20),'Inflacja podgryza got√≥wkƒô.','neutral'], buy_bonds_90:[R(30,90),'Spadek st√≥p pomaga obligacjom.','profit'], buy_pc_90:[R(-60,200),'PC boom nie bez waha≈Ñ.','neutral'], buy_index_95:[R(60,140),'Rynek byka wynagradza pasywnych.','profit'], buy_scv_95:[R(40,160),'Small-value dajƒÖ radƒô.','profit'], buy_telco_95:[R(-40,80),'Telco po≈Çowicznie; uwaga na d≈Çug.','neutral'], stay_def_95:[R(-20,40),'Za konserwatywnie ‚Äî mniejszy zysk.','neutral'], buy_dip_97:[R(60,160),'USA odbi≈Çy szybko.','profit'], bonds_97:[R(10,70),'Bezpieczny parking kapita≈Çu.','neutral'], short_em_97:[R(80,220),'EM cierpia≈Çy ‚Äî short dzia≈Ça.','profit'], gold_97:[R(-30,30),'Z≈Çoto bez fajerwerk√≥w.','neutral'], buy_after_fed_98:[R(80,200),'Don‚Äôt fight the Fed.','profit'], hold_98:[R(-20,30),'Ok, ale przepu≈õci≈Çe≈õ odbicie.','neutral'], short_fin_98:[R(-100,120),'Lewar bywa zdradliwy.','neutral'], buy_momo_98:[R(40,220),'Momentum dzia≈Ça‚Ä¶ do czasu.','profit'], allin_dotcom_99:[R(-500,400),'Wysokie ryzyko ‚Äî mo≈ºe zaboleƒá.','neutral'], rot_value_99:[R(60,180),'Value gotowe na rotacjƒô.','profit'], rebal_99:[R(40,120),'Dyscyplina pop≈Çaca.','profit'], short_hyper_99:[R(120,320),'Short bƒÖbla bywa z≈Çotem.','profit'],
          // DotCom
          buy_ipos_00:[R(-420,220),'IPO czƒôsto wracajƒÖ do ceny emisyjnej.','loss'], rot_quality_00:[R(40,160),'Zyskowne techy przetrwa≈Çy.','profit'], rot_value_00:[R(60,200),'Value wygrywa w bessie tech.','profit'], short_extreme_00:[R(120,360),'Skrajne wyceny pƒôkajƒÖ.','profit'], hold_bag_00:[R(-280,40),'‚ÄûD≈Çugo-terminowo" zabola≈Ço.','loss'], move_cash_00:[R(20,80),'Kapita≈Ç zachowany.','neutral'], buy_prof_00:[R(-40,140),'Selekcja dzia≈Ça, ale zmienno≈õƒá du≈ºa.','neutral'], hedge_00:[R(40,120),'Hedge amortyzuje spadki.','profit'], buy_defense_01:[R(40,120),'Kontrakty rzƒÖdowe pomagajƒÖ.','profit'], short_travel_01:[R(80,200),'Travel pod presjƒÖ.','profit'], hold_cash_01:[R(-10,40),'Bezpiecznie, ale stracone szanse.','neutral'], buy_quality_01:[R(-40,120),'Selekcja nadal trudna.','neutral'], buy_leaders_02:[R(60,200),'Liderzy wracajƒÖ pierwsi.','profit'], buy_value_02:[R(60,180),'Cashflow > marzenia.','profit'], stay_bonds_02:[R(10,60),'Stabilnie, ale ni≈ºszy zwrot.','neutral'], penny_02:[R(-200,200),'Kasyno: ksiƒô≈ºyc albo zero.','neutral'],
          // Black Monday 1987
          stay_bull_87:[R(-150,50),'Kupi≈Çe≈õ szczyt przed krachem.','loss'], buy_puts_87:[R(180,350),'Opcje put ‚Äì zabezpieczenie zadzia≈Ça≈Ço!','profit'], rotate_bonds_87:[R(40,100),'Obligacje uciek≈Çy przed burzƒÖ.','profit'], short_fut_87:[R(200,420),'Short futures ‚Äì trafi≈Çe≈õ!','profit'], sell_friday_87:[R(120,200),'Doskona≈Ça decyzja ‚Äì uciek≈Çe≈õ przed krachem.','profit'], buy_dip_87:[R(-280,80),'Spadki by≈Çy g≈Çƒôbsze ni≈º my≈õla≈Çe≈õ.','loss'], hold_87:[R(-220,40),'To nie by≈Ça zwyk≈Ça korekta.','loss'], more_puts_87:[R(280,480),'Podw√≥jne zabezpieczenie ‚Äì jackpot!','profit'], panic_sell_87:[R(-150,20),'Sprzeda≈Çe≈õ w panice po najgorszych cenach.','loss'], buy_crash_87:[R(200,450),'Kupno w dniu krachu ‚Äì legendarny ruch!','profit'], wait_stable_87:[R(60,140),'Cierpliwo≈õƒá pop≈Çaca ‚Äì kupi≈Çe≈õ ni≈ºej.','profit'], short_more_87:[R(-120,180),'Odbicie by≈Ço szybsze ni≈º siƒô spodziewa≈Çe≈õ.','neutral'], buy_quality_87:[R(100,240),'Quality blue chips wr√≥ci≈Çy mocno.','profit'], buy_tech_87:[R(80,200),'Tech ro≈õnie ‚Äì Microsoft na fali.','profit'], stay_def_87:[R(20,80),'Bezpiecznie, ale wolniej.','neutral'], keep_cash_87:[R(-20,40),'Przegapi≈Çe≈õ odbicie.','neutral'],
          // GFC 2008
          short_mbs_07:[R(180,400),'Kr√≥tka MBS/housing ‚Äî trafione.','profit'], move_quality_07:[R(20,80),'Jako≈õƒá daje poduszkƒô.','neutral'], ignore_07:[R(-140,60),'To nie by≈Ço ‚Äûlokalne‚Äù.','loss'], gold_07:[R(40,120),'Bezpieczna przysta≈Ñ.','profit'], buy_banks_08:[R(-260,180),'Za wcze≈õnie ‚Äî jeszcze spad≈Ço.','neutral'], short_fin_08:[R(120,360),'Finanse pod presjƒÖ ‚Äî zysk.','profit'], cash_08:[R(20,60),'Kapita≈Ç zachowany.','neutral'], def_08:[R(-40,80),'Defensywy mniej bolƒÖ.','neutral'], buy_index_09:[R(160,380),'Kupno dna ‚Äî nagrodzone.','profit'], safe_haven_08:[R(40,140),'Z≈Çoto/obligacje dajƒÖ ulgƒô.','profit'], short_cyc_08:[R(80,220),'Cykliczne cierpia≈Çy.','profit'], stay_cash_08:[R(-10,40),'Bezpiecznie, ale przegapisz odbicie.','neutral'], allin_09:[R(220,480),'Historyczny trade ≈ºycia.','profit'], buy_value_09:[R(140,320),'Value/finanse z odbiciem.','profit'], stay_bonds_09:[R(20,80),'Stabilnie, mniejszy zwrot.','neutral'], wait_09:[R(-40,60),'Za d≈Çugo czekasz ‚Äî rynek ucieka.','neutral']
        };
        if(outcomes[effect]){ [moneyChange,message,type]=outcomes[effect]; }
        else { moneyChange = R(-100,120); message='Efekt zale≈ºy od timingu rynku.'; type = moneyChange>0?'profit':(moneyChange<0?'loss':'neutral'); }
        return { moneyChange, message, type };
      }

      function makeChoice(choiceIndex){
        const ch = chapters[currentChapterKey];
        const s = ch.scenarios[currentScenario];
        const choice = s.choices[choiceIndex];
        const result = calculateResult(choice.effect);
        decisions++;
        capital = Math.max(0, Math.round(capital + result.moneyChange));
        capitalHistory.push(capital); // Track capital after each decision
        showResult(choice, result);
        checkAchievements(result); // Check for unlocked achievements
        setTimeout(()=>{ currentScenario++; if(currentScenario>=ch.scenarios.length) endGame(); else renderScenario(); }, 2200);
      }

      // --------- ACHIEVEMENTS SYSTEM ---------
      const achievementDefinitions = {
        'first_profit': { icon: 'üí∞', name: 'Pierwszy Zysk', desc: 'Zarobi≈Ç pierwszego dolara' },
        'big_win': { icon: 'üéØ', name: 'Wielka Wygrana', desc: 'Zysk +$500 w jednej decyzji' },
        'survivor': { icon: 'üíé', name: 'Survival', desc: 'Uko≈Ñczy≈Ç epokƒô z kapita≈Çem powy≈ºej startu' },
        'millionaire': { icon: 'üëë', name: 'Milioner', desc: 'OsiƒÖgnƒÖ≈Ç $10,000+' },
        'perfect_timing': { icon: '‚è∞', name: 'Perfect Timing', desc: '3 zyski z rzƒôdu' },
        'risk_taker': { icon: 'üé≤', name: 'Ryzykant', desc: 'Straci≈Ç $500+ w jednej decyzji' },
        'comeback_king': { icon: 'üî•', name: 'Comeback King', desc: 'Odrobi≈Ç straty i wyszed≈Ç na plus' }
      };

      let profitStreak = 0;

      function checkAchievements(result){
        const unlocked = [];

        // First profit
        if(result.moneyChange > 0 && !achievements.includes('first_profit')){
          unlocked.push('first_profit');
          profitStreak++;
        } else if(result.moneyChange < 0){
          profitStreak = 0;
        } else if(result.moneyChange > 0){
          profitStreak++;
        }

        // Big win
        if(result.moneyChange >= 500 && !achievements.includes('big_win')){
          unlocked.push('big_win');
        }

        // Perfect timing (3 profits in a row)
        if(profitStreak >= 3 && !achievements.includes('perfect_timing')){
          unlocked.push('perfect_timing');
        }

        // Risk taker
        if(result.moneyChange <= -500 && !achievements.includes('risk_taker')){
          unlocked.push('risk_taker');
        }

        // Millionaire
        if(capital >= 10000 && !achievements.includes('millionaire')){
          unlocked.push('millionaire');
        }

        // Add to global achievements
        unlocked.forEach(id => {
          if(!achievements.includes(id)){
            achievements.push(id);
            showAchievementNotification(id);
          }
        });
      }

      function showAchievementNotification(achievementId){
        const ach = achievementDefinitions[achievementId];
        if(!ach) return;

        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
          <div class="achievement-content">
            <span class="achievement-icon">${ach.icon}</span>
            <div>
              <div class="achievement-name">üéñÔ∏è ${ach.name}</div>
              <div class="achievement-desc">${ach.desc}</div>
            </div>
          </div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 500);
        }, 3000);
      }

      function showResult(choice, result){
        const panel = document.createElement('div');
        panel.className = 'result-panel';
        panel.innerHTML = `
          <h3 class="panel-title">Wynik decyzji</h3>
          <p><strong>Wybra≈Çe≈õ:</strong> ${choice.text}</p>
          <p class="${result.type}"><strong>Rezultat:</strong> ${result.message}</p>
          <p class="${result.type}"><strong>Zmiana kapita≈Çu:</strong> ${result.moneyChange>0?'+':''}${result.moneyChange} $</p>`;
        dom.gameContent.prepend(panel);
        dom.capital.textContent = `$${capital.toLocaleString()}`;
      }

      // --------- CAPITAL CHART ---------
      function renderCapitalChart(){
        if(capitalHistory.length < 2) return '<p style="text-align:center;color:var(--muted);">Brak danych do wykresu</p>';

        const width = 600;
        const height = 180;
        const padding = 40;
        const max = Math.max(...capitalHistory);
        const min = Math.min(...capitalHistory);
        const range = max - min || 1;

        // Calculate points
        const points = capitalHistory.map((val, i) => {
          const x = padding + (i / (capitalHistory.length - 1)) * (width - 2 * padding);
          const y = height - padding - ((val - min) / range) * (height - 2 * padding);
          return `${x},${y}`;
        }).join(' ');

        // Area fill points (add bottom corners)
        const areaPoints = `${padding},${height - padding} ` + points + ` ${width - padding},${height - padding}`;

        const startCap = capitalHistory[0];
        const endCap = capitalHistory[capitalHistory.length - 1];
        const change = endCap - startCap;
        const changePercent = ((change / startCap) * 100).toFixed(1);
        const changeColor = change >= 0 ? 'var(--win)' : 'var(--loss)';

        return `
          <div class="capital-chart">
            <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}">
              <defs>
                <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:var(--accent-2);stop-opacity:0.6" />
                  <stop offset="100%" style="stop-color:var(--accent-2);stop-opacity:0.1" />
                </linearGradient>
              </defs>

              <!-- Grid lines -->
              <line class="chart-grid" x1="${padding}" y1="${padding}" x2="${width - padding}" y2="${padding}" />
              <line class="chart-grid" x1="${padding}" y1="${height/2}" x2="${width - padding}" y2="${height/2}" />
              <line class="chart-grid" x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" />

              <!-- Area -->
              <polygon class="chart-area" points="${areaPoints}" />

              <!-- Line -->
              <polyline class="chart-line" points="${points}" />

              <!-- Labels -->
              <text class="chart-label" x="${padding}" y="${height - 10}">Start: $${startCap.toLocaleString()}</text>
              <text class="chart-label" x="${width - padding - 100}" y="${height - 10}">Koniec: $${endCap.toLocaleString()}</text>
              <text class="chart-label" x="${width/2 - 50}" y="20" fill="${changeColor}" font-weight="bold">${change >= 0 ? '+' : ''}${changePercent}%</text>
            </svg>
          </div>
        `;
      }

      function endGame(){
        console.log('üèÅ Game ended!');
        updateProgress();

        // Check final achievement
        const startCap = capitalHistory[0];
        if(capital > startCap && !achievements.includes('survivor')){
          achievements.push('survivor');
        }

        // Generate achievements HTML
        const achievementsHTML = achievements.length > 0 ? `
          <div style="margin:20px 0;">
            <h3 class="panel-title">üéñÔ∏è OsiƒÖgniƒôcia (${achievements.length})</h3>
            <div class="achievements-grid">
              ${achievements.map(id => {
                const ach = achievementDefinitions[id];
                return ach ? `
                  <div class="achievement-badge">
                    <span class="achievement-badge-icon">${ach.icon}</span>
                    <div class="achievement-badge-name">${ach.name}</div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
        ` : '';

        dom.gameContent.innerHTML = `
          <div class="result-panel">
            <h3 class="panel-title">üèÜ Koniec rozdzia≈Çu</h3>
            <p>≈ÅƒÖczna liczba decyzji: <strong>${decisions}</strong></p>
            <p>Ko≈Ñcowy kapita≈Ç: <strong class="${capital >= startCap ? 'profit' : 'loss'}">$${capital.toLocaleString()}</strong></p>

            <h4 style="margin-top:24px;color:var(--accent-2);">üìà Wykres Kapita≈Çu</h4>
            ${renderCapitalChart()}

            ${achievementsHTML}

            <div style="display:flex;gap:12px;margin-top:24px;justify-content:center;">
              <button class="restart" id="restartChapter">üîÑ Zagraj ponownie</button>
              <button class="restart" id="backToMenu">üè† Wr√≥ƒá do menu</button>
            </div>
          </div>`;

        // Add event listeners to buttons
        const restartBtn = document.getElementById('restartChapter');
        const menuBtn = document.getElementById('backToMenu');

        if (restartBtn) {
          restartBtn.addEventListener('click', () => {
            console.log('üîÑ Restarting chapter:', currentChapterKey);
            startChapter(currentChapterKey);
          });
        }

        if (menuBtn) {
          menuBtn.addEventListener('click', () => {
            console.log('üè† Going back to menu');
            showMainMenu();
          });
        }

        console.log('‚úÖ End game screen ready');
      }

      // INIT - Initialize everything after DOM loads
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM loaded, initializing game...');
        initMenuSystem();
        console.log('‚úÖ Game ready!');
      });

      // Also call immediately in case DOMContentLoaded already fired
      if (document.readyState === 'loading') {
        console.log('‚è≥ Waiting for DOM...');
      } else {
        console.log('üìÑ DOM already loaded, initializing now...');
        initMenuSystem();
      }

      // Functions are now used via event listeners, no need to export

    } catch (e) {
      showError(e.message || String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
